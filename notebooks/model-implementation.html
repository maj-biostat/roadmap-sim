<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.542">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-04-11">

<title>ROADMAP - design notes and simulations - Model implementation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://hypothes.is/embed.js"></script>
<script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">ROADMAP - design notes and simulations</span>
    </a>
  </div>
        <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/maj-biostat/roadmap-sim">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/maj-biostat/roadmap-sim/issues">
            Report a Bug
            </a>
          </li>
      </ul>
    </div>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/population-structure.html">Design</a></li><li class="breadcrumb-item"><a href="../notebooks/model-implementation.html">Model implementation</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Design</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/population-structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Population structure</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/model-spec.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model specification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/decision-rules.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Decision rules</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/simulation-pars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulation setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/trial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulated trial data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/model-implementation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Model implementation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/example-trials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Example trials</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/sim-design1-results.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulation results 1</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/sim-design3-results.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulation results 3</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/design-notes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Design Notes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/misc-notes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reminders</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#stan-implementation" id="toc-stan-implementation" class="nav-link active" data-scroll-target="#stan-implementation">Stan implementation</a></li>
  <li><a href="#estimation---g-computation" id="toc-estimation---g-computation" class="nav-link" data-scroll-target="#estimation---g-computation">Estimation - G-computation</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/population-structure.html">Design</a></li><li class="breadcrumb-item"><a href="../notebooks/model-implementation.html">Model implementation</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Model implementation</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 11, 2024</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">April 11, 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<div class="cell">

</div>
<p>The model used for the simulations translates the binary outcome into a binomial outcome by aggregating over the unique groups. For example with the linear predictor:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># data generation process</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">formals</span>(roadmap.data<span class="sc">::</span>get_trial_data)<span class="sc">$</span>g</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function(d, sim_spec) {
    a0 &lt;- sim_spec$a0
    m &lt;- sim_spec$m
    b &lt;- sim_spec$b
    eta &lt;- a0 + m["l1"] * d$l1 + m["l2"] * d$l2 + (b["erx-r0"] * 
        d$srp0 + b["erx-r1"] * d$srp1 + b["erx-r2"] * d$srp2) * 
        d$erx + (b["r1"] * d$srp1 + b["r2"] * d$srp2) * d$r * 
        d$er + (b["r1d"] * d$d * d$srp1 + b["r2d"] * d$d * d$srp2) * 
        d$ed + b["efx"] * d$efx + b["f"] * d$f * d$ef
    eta
}</code></pre>
</div>
</div>
<p>I get:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># simulate data</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb3-3"><a href="#cb3-3"></a>sim_spec <span class="ot">&lt;-</span> roadmap.data<span class="sc">::</span><span class="fu">get_sim_spec</span>()</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="fu">unlist</span>(sim_spec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         a0        m.l1        m.l2    b.erx-r0    b.erx-r1    b.erx-r2 
 0.61903921 -0.33718806 -0.08682239 -0.10000000  0.10000000  0.05000000 
       b.r1        b.r2       b.r1d       b.r2d       b.efx         b.f 
 0.20000000  0.09000000  0.30000000  0.10000000  0.25000000  0.15000000 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>ll <span class="ot">&lt;-</span> roadmap.data<span class="sc">::</span><span class="fu">get_trial_data</span>(<span class="at">N =</span> <span class="dv">2500</span>, <span class="at">sim_spec =</span> sim_spec)</span>
<span id="cb5-2"><a href="#cb5-2"></a>d <span class="ot">&lt;-</span> <span class="fu">copy</span>(ll<span class="sc">$</span>d)</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="fu">head</span>(d[, .(<span class="at">y =</span> <span class="fu">sum</span>(y), <span class="at">n =</span> .N), <span class="at">keyby =</span> .(l, er, ed, ef, r, srp0, srp1, srp2, d, f)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   l er ed ef r srp0 srp1 srp2 d f   y   n
1: 0  0  0  0 0    1    0    0 0 0 167 247
2: 0  0  0  1 0    1    0    0 0 0 112 193
3: 0  0  0  1 0    1    0    0 0 1 116 197
4: 0  0  1  0 0    0    1    0 0 0  12  15
5: 0  0  1  0 0    0    1    0 1 0  11  12
6: 0  0  1  1 0    0    1    0 0 0   5   7</code></pre>
</div>
</div>
<p>The columns correspond to:</p>
<ul>
<li>l: strata 0 early, 1 late, 2 chronic</li>
<li>er: revealed indicator surgery</li>
<li>ed: revealed indicator duration</li>
<li>ef: revealed indicator choice</li>
<li>r: randomisation for surgery domain, dair vs rev</li>
<li>srp0: indicator for dair performed</li>
<li>srp1: indicator for one-stage performed</li>
<li>srp2: indicator for two-stage performed</li>
<li>d: indicator for duration (see below)</li>
<li>f: indicator for choice (0 no-rif, 1 rif)</li>
<li>y: number of treatment success</li>
<li>n: number of patients</li>
</ul>
<!-- + rp: indicator of surgical approach that was performed (0 dair, 1 rev) -->
<p>Duration domain depends on what surgery was received, NOT what was originally planned/assigned. For one-stage 12-weeks is reference group (indicated by 0) vs 6 weeks. For two-stage 7 days is reference group (indicated by 0) vs 12 weeks (1).</p>
<p>Within early, late and chronic stage infection, the percentage (by silo, <code>l</code>) receiving each surgery type (<code>srp</code>) as a randomised or non-randomised treatment (<code>er</code>) are:</p>
<div class="cell">
<details class="code-fold">
<summary>Percent receiving each surgery type within silo</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>ll <span class="ot">&lt;-</span> roadmap.data<span class="sc">::</span><span class="fu">get_trial_data</span>(<span class="at">N =</span> <span class="fl">1e6</span>, <span class="at">sim_spec =</span> sim_spec)</span>
<span id="cb7-2"><a href="#cb7-2"></a>d_tbl <span class="ot">&lt;-</span> ll<span class="sc">$</span>d[, .(<span class="at">n =</span> .N), keyby <span class="ot">=</span> .(l, er, srp)]</span>
<span id="cb7-3"><a href="#cb7-3"></a>d_tbl[, N_l <span class="sc">:</span><span class="er">=</span> <span class="fu">sum</span>(n), keyby <span class="ot">=</span> l]</span>
<span id="cb7-4"><a href="#cb7-4"></a>d_tbl[, pct <span class="sc">:</span><span class="er">=</span> <span class="dv">100</span> <span class="sc">*</span> n <span class="sc">/</span> N_l]</span>
<span id="cb7-5"><a href="#cb7-5"></a>d_tbl[, N_l <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb7-6"><a href="#cb7-6"></a>d_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    l er srp      n        pct
 1: 0  0   0 270730 90.0593121
 2: 0  0   1  29883  9.9406879
 3: 1  0   0   2028  0.4059987
 4: 1  0   1   2332  0.4668585
 5: 1  0   2   5717  1.1445239
 6: 1  1   0 244552 48.9584772
 7: 1  1   1  73803 14.7751092
 8: 1  1   2 171077 34.2490325
 9: 2  0   0  39954 19.9891934
10: 2  0   1  40146 20.0852520
11: 2  0   2 119778 59.9255546</code></pre>
</div>
</div>
<section id="stan-implementation" class="level2">
<h2 class="anchored" data-anchor-id="stan-implementation">Stan implementation</h2>
<p>The model spec can be translated into stan, albeit using a different likelihood spec:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb9-1"><a href="#cb9-1"></a></span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="kw">data</span> {</span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="dt">int</span> N;</span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="dt">array</span>[N] <span class="dt">int</span> y;</span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="dt">array</span>[N] <span class="dt">int</span> n;</span>
<span id="cb9-7"><a href="#cb9-7"></a>  <span class="co">// variation due to silo/joint</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>  <span class="dt">vector</span>[N] l1;</span>
<span id="cb9-9"><a href="#cb9-9"></a>  <span class="dt">vector</span>[N] l2;</span>
<span id="cb9-10"><a href="#cb9-10"></a>  <span class="co">// reveal</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>  <span class="dt">vector</span>[N] er;</span>
<span id="cb9-12"><a href="#cb9-12"></a>  <span class="dt">vector</span>[N] ed;</span>
<span id="cb9-13"><a href="#cb9-13"></a>  <span class="dt">vector</span>[N] ef;</span>
<span id="cb9-14"><a href="#cb9-14"></a>  <span class="co">// surgery</span></span>
<span id="cb9-15"><a href="#cb9-15"></a>  <span class="dt">vector</span>[N] r;</span>
<span id="cb9-16"><a href="#cb9-16"></a>  <span class="co">// duration</span></span>
<span id="cb9-17"><a href="#cb9-17"></a>  <span class="dt">vector</span>[N] d;</span>
<span id="cb9-18"><a href="#cb9-18"></a>  <span class="co">// vector[N] rp; // revision was recvd</span></span>
<span id="cb9-19"><a href="#cb9-19"></a>  <span class="dt">vector</span>[N] srp0; <span class="co">// dair recvd</span></span>
<span id="cb9-20"><a href="#cb9-20"></a>  <span class="dt">vector</span>[N] srp1; <span class="co">// one-stage revision recvd</span></span>
<span id="cb9-21"><a href="#cb9-21"></a>  <span class="dt">vector</span>[N] srp2; <span class="co">// two-stage revision recvd</span></span>
<span id="cb9-22"><a href="#cb9-22"></a>  <span class="co">// choice</span></span>
<span id="cb9-23"><a href="#cb9-23"></a>  <span class="dt">vector</span>[N] f;</span>
<span id="cb9-24"><a href="#cb9-24"></a>  </span>
<span id="cb9-25"><a href="#cb9-25"></a>  <span class="dt">vector</span>[<span class="dv">2</span>] pri_m_sd;</span>
<span id="cb9-26"><a href="#cb9-26"></a>  <span class="dt">vector</span>[<span class="dv">9</span>] pri_b_sd;</span>
<span id="cb9-27"><a href="#cb9-27"></a>  <span class="dt">int</span> prior_only;</span>
<span id="cb9-28"><a href="#cb9-28"></a>}</span>
<span id="cb9-29"><a href="#cb9-29"></a><span class="kw">transformed data</span>{</span>
<span id="cb9-30"><a href="#cb9-30"></a>  <span class="dt">vector</span>[N] erx_srp0;</span>
<span id="cb9-31"><a href="#cb9-31"></a>  <span class="dt">vector</span>[N] erx_srp1;</span>
<span id="cb9-32"><a href="#cb9-32"></a>  <span class="dt">vector</span>[N] erx_srp2;</span>
<span id="cb9-33"><a href="#cb9-33"></a>  <span class="dt">vector</span>[N] er_r;</span>
<span id="cb9-34"><a href="#cb9-34"></a>  <span class="dt">vector</span>[N] er_r_srp1;</span>
<span id="cb9-35"><a href="#cb9-35"></a>  <span class="dt">vector</span>[N] er_r_srp2;</span>
<span id="cb9-36"><a href="#cb9-36"></a>  <span class="dt">vector</span>[N] ed_d_srp1;</span>
<span id="cb9-37"><a href="#cb9-37"></a>  <span class="dt">vector</span>[N] ed_d_srp2;</span>
<span id="cb9-38"><a href="#cb9-38"></a>  <span class="dt">vector</span>[N] ef_f;</span>
<span id="cb9-39"><a href="#cb9-39"></a>  </span>
<span id="cb9-40"><a href="#cb9-40"></a>  erx_srp0 = (<span class="dv">1</span>-er) .* srp0;</span>
<span id="cb9-41"><a href="#cb9-41"></a>  erx_srp1 = (<span class="dv">1</span>-er) .* srp1;</span>
<span id="cb9-42"><a href="#cb9-42"></a>  erx_srp2 = (<span class="dv">1</span>-er) .* srp2;</span>
<span id="cb9-43"><a href="#cb9-43"></a>  </span>
<span id="cb9-44"><a href="#cb9-44"></a>  er_r = er .* r;</span>
<span id="cb9-45"><a href="#cb9-45"></a>  </span>
<span id="cb9-46"><a href="#cb9-46"></a>  er_r_srp1 = er_r .* srp1;</span>
<span id="cb9-47"><a href="#cb9-47"></a>  er_r_srp2 = er_r .* srp2;</span>
<span id="cb9-48"><a href="#cb9-48"></a></span>
<span id="cb9-49"><a href="#cb9-49"></a><span class="co">// you can remove rp srp1 indicates one-stage happened, srp2 indicates two stage</span></span>
<span id="cb9-50"><a href="#cb9-50"></a><span class="co">// the rp becomes redundant.</span></span>
<span id="cb9-51"><a href="#cb9-51"></a>  ed_d_srp1 = ed .* d .* srp1;</span>
<span id="cb9-52"><a href="#cb9-52"></a>  ed_d_srp2 = ed .* d .* srp2;</span>
<span id="cb9-53"><a href="#cb9-53"></a></span>
<span id="cb9-54"><a href="#cb9-54"></a>  ef_f = ef .* f;</span>
<span id="cb9-55"><a href="#cb9-55"></a>}</span>
<span id="cb9-56"><a href="#cb9-56"></a><span class="kw">parameters</span> {</span>
<span id="cb9-57"><a href="#cb9-57"></a>  <span class="dt">real</span> a0;</span>
<span id="cb9-58"><a href="#cb9-58"></a>  <span class="dt">vector</span>[<span class="dv">2</span>] m;</span>
<span id="cb9-59"><a href="#cb9-59"></a>  <span class="dt">vector</span>[<span class="dv">9</span>] b;</span>
<span id="cb9-60"><a href="#cb9-60"></a>}</span>
<span id="cb9-61"><a href="#cb9-61"></a><span class="kw">transformed parameters</span>{</span>
<span id="cb9-62"><a href="#cb9-62"></a>  <span class="dt">vector</span>[N] eta;</span>
<span id="cb9-63"><a href="#cb9-63"></a> </span>
<span id="cb9-64"><a href="#cb9-64"></a>  eta = a0 + </span>
<span id="cb9-65"><a href="#cb9-65"></a>      m[<span class="dv">1</span>]*l1 + m[<span class="dv">2</span>]*l2 +  </span>
<span id="cb9-66"><a href="#cb9-66"></a>      (b[<span class="dv">1</span>]*erx_srp0 + b[<span class="dv">2</span>]*erx_srp1 + b[<span class="dv">3</span>]*erx_srp2)  +</span>
<span id="cb9-67"><a href="#cb9-67"></a>      (b[<span class="dv">4</span>]*er_r_srp1 + b[<span class="dv">5</span>]*er_r_srp2) +</span>
<span id="cb9-68"><a href="#cb9-68"></a>      <span class="co">// b[6] * (1 - ed) + </span></span>
<span id="cb9-69"><a href="#cb9-69"></a>      (b[<span class="dv">6</span>]*ed_d_srp1 + b[<span class="dv">7</span>]*ed_d_srp2)  + </span>
<span id="cb9-70"><a href="#cb9-70"></a>      b[<span class="dv">8</span>] * (<span class="dv">1</span> - ef) + (b[<span class="dv">9</span>]*ef_f);</span>
<span id="cb9-71"><a href="#cb9-71"></a>      </span>
<span id="cb9-72"><a href="#cb9-72"></a>}</span>
<span id="cb9-73"><a href="#cb9-73"></a><span class="kw">model</span>{</span>
<span id="cb9-74"><a href="#cb9-74"></a>  <span class="kw">target +=</span> normal_lpdf(a0 | <span class="dv">0</span>, <span class="fl">1.5</span>);</span>
<span id="cb9-75"><a href="#cb9-75"></a>  <span class="kw">target +=</span> normal_lpdf(m | <span class="dv">0</span>, pri_m_sd);</span>
<span id="cb9-76"><a href="#cb9-76"></a>  <span class="kw">target +=</span> normal_lpdf(b | <span class="dv">0</span>, pri_b_sd);</span>
<span id="cb9-77"><a href="#cb9-77"></a>  </span>
<span id="cb9-78"><a href="#cb9-78"></a>  <span class="co">// likelihood chunks pertaining to each silo</span></span>
<span id="cb9-79"><a href="#cb9-79"></a>  <span class="cf">if</span>(!prior_only){</span>
<span id="cb9-80"><a href="#cb9-80"></a>    <span class="kw">target +=</span> binomial_logit_lpmf(y | n, eta) ;      </span>
<span id="cb9-81"><a href="#cb9-81"></a>  }</span>
<span id="cb9-82"><a href="#cb9-82"></a>  </span>
<span id="cb9-83"><a href="#cb9-83"></a>  </span>
<span id="cb9-84"><a href="#cb9-84"></a>}</span>
<span id="cb9-85"><a href="#cb9-85"></a><span class="kw">generated quantities</span>{</span>
<span id="cb9-86"><a href="#cb9-86"></a></span>
<span id="cb9-87"><a href="#cb9-87"></a>  <span class="dt">vector</span>[N] eta_r_0;</span>
<span id="cb9-88"><a href="#cb9-88"></a>  <span class="dt">vector</span>[N] eta_r_1;</span>
<span id="cb9-89"><a href="#cb9-89"></a>  <span class="dt">vector</span>[N] eta_d_0;</span>
<span id="cb9-90"><a href="#cb9-90"></a>  <span class="dt">vector</span>[N] eta_d_1;</span>
<span id="cb9-91"><a href="#cb9-91"></a>  <span class="dt">vector</span>[N] eta_f_0;</span>
<span id="cb9-92"><a href="#cb9-92"></a>  <span class="dt">vector</span>[N] eta_f_1;</span>
<span id="cb9-93"><a href="#cb9-93"></a></span>
<span id="cb9-94"><a href="#cb9-94"></a>  {</span>
<span id="cb9-95"><a href="#cb9-95"></a></span>
<span id="cb9-96"><a href="#cb9-96"></a>    <span class="co">// predictions on log-odds scale setting all participants to the level</span></span>
<span id="cb9-97"><a href="#cb9-97"></a>    <span class="co">// of interest, e.g. assume all have r = 0</span></span>
<span id="cb9-98"><a href="#cb9-98"></a>    eta_r_0   =  a0 +</span>
<span id="cb9-99"><a href="#cb9-99"></a>      m[<span class="dv">1</span>]*l1   + m[<span class="dv">2</span>]*l2 +</span>
<span id="cb9-100"><a href="#cb9-100"></a>      (b[<span class="dv">1</span>] * erx_srp0 + b[<span class="dv">2</span>] * erx_srp1 + b[<span class="dv">3</span>] * erx_srp2) +</span>
<span id="cb9-101"><a href="#cb9-101"></a>      <span class="co">// b[6] * (1 - ed  ) + </span></span>
<span id="cb9-102"><a href="#cb9-102"></a>      (b[<span class="dv">6</span>]*ed_d_srp1   + b[<span class="dv">7</span>]*ed_d_srp2)   +</span>
<span id="cb9-103"><a href="#cb9-103"></a>      b[<span class="dv">8</span>] * (<span class="dv">1</span> - ef  ) + (b[<span class="dv">9</span>]*ef_f)  ;</span>
<span id="cb9-104"><a href="#cb9-104"></a>    <span class="co">// r = 1</span></span>
<span id="cb9-105"><a href="#cb9-105"></a>    <span class="co">// (only those revealed to surgery domain contribute due to the er term)</span></span>
<span id="cb9-106"><a href="#cb9-106"></a>    eta_r_1   =  a0 +</span>
<span id="cb9-107"><a href="#cb9-107"></a>      m[<span class="dv">1</span>]*l1   + m[<span class="dv">2</span>]*l2 +</span>
<span id="cb9-108"><a href="#cb9-108"></a>      <span class="co">// note the use of er here and not er_r, i.e. the r is set to 1 for</span></span>
<span id="cb9-109"><a href="#cb9-109"></a>      <span class="co">// everyone</span></span>
<span id="cb9-110"><a href="#cb9-110"></a>      (b[<span class="dv">1</span>] * erx_srp0 + b[<span class="dv">2</span>] * erx_srp1 + b[<span class="dv">3</span>] * erx_srp2) +</span>
<span id="cb9-111"><a href="#cb9-111"></a>      (b[<span class="dv">4</span>]*er .* srp1 + b[<span class="dv">5</span>]*er .* srp2) +</span>
<span id="cb9-112"><a href="#cb9-112"></a>      <span class="co">// b[6] * (1 - ed  ) + </span></span>
<span id="cb9-113"><a href="#cb9-113"></a>      (b[<span class="dv">6</span>]*ed_d_srp1   + b[<span class="dv">7</span>]*ed_d_srp2)   +</span>
<span id="cb9-114"><a href="#cb9-114"></a>      b[<span class="dv">8</span>] * (<span class="dv">1</span> - ef  ) + (b[<span class="dv">9</span>]*ef_f);</span>
<span id="cb9-115"><a href="#cb9-115"></a></span>
<span id="cb9-116"><a href="#cb9-116"></a>    <span class="co">// duration, d = 0</span></span>
<span id="cb9-117"><a href="#cb9-117"></a>    eta_d_0   =  a0 +</span>
<span id="cb9-118"><a href="#cb9-118"></a>      m[<span class="dv">1</span>]*l1 + m[<span class="dv">2</span>]*l2 +</span>
<span id="cb9-119"><a href="#cb9-119"></a>      (b[<span class="dv">1</span>] * erx_srp0 + b[<span class="dv">2</span>] * erx_srp1 + b[<span class="dv">3</span>] * erx_srp2) +</span>
<span id="cb9-120"><a href="#cb9-120"></a>      (b[<span class="dv">4</span>]*er_r_srp1 + b[<span class="dv">5</span>]*er_r_srp2) +</span>
<span id="cb9-121"><a href="#cb9-121"></a>      <span class="co">// b[6] * (1 - ed) +</span></span>
<span id="cb9-122"><a href="#cb9-122"></a>      b[<span class="dv">8</span>] * (<span class="dv">1</span> - ef) + (b[<span class="dv">9</span>]*ef_f);</span>
<span id="cb9-123"><a href="#cb9-123"></a>    <span class="co">// d = 1</span></span>
<span id="cb9-124"><a href="#cb9-124"></a>    eta_d_1   =  a0 +</span>
<span id="cb9-125"><a href="#cb9-125"></a>      m[<span class="dv">1</span>]*l1 + m[<span class="dv">2</span>]*l2 +</span>
<span id="cb9-126"><a href="#cb9-126"></a>      (b[<span class="dv">1</span>] * erx_srp0 + b[<span class="dv">2</span>] * erx_srp1 + b[<span class="dv">3</span>] * erx_srp2) +</span>
<span id="cb9-127"><a href="#cb9-127"></a>      (b[<span class="dv">4</span>]*er_r_srp1 + b[<span class="dv">5</span>]*er_r_srp2) +</span>
<span id="cb9-128"><a href="#cb9-128"></a>      <span class="co">// note the use of ed and rp here and not ed_rp_d_srp1, i.e. the d is</span></span>
<span id="cb9-129"><a href="#cb9-129"></a>      <span class="co">// set to 1 for everyone</span></span>
<span id="cb9-130"><a href="#cb9-130"></a>      <span class="co">// b[6] * (1 - ed) + </span></span>
<span id="cb9-131"><a href="#cb9-131"></a>      (b[<span class="dv">6</span>]*ed .* srp1 + b[<span class="dv">7</span>]*ed .* srp2)  +</span>
<span id="cb9-132"><a href="#cb9-132"></a>      b[<span class="dv">8</span>] * (<span class="dv">1</span> - ef) + (b[<span class="dv">9</span>]*ef_f);</span>
<span id="cb9-133"><a href="#cb9-133"></a></span>
<span id="cb9-134"><a href="#cb9-134"></a>    <span class="co">// choice, f = 0</span></span>
<span id="cb9-135"><a href="#cb9-135"></a>    eta_f_0   =  a0 +</span>
<span id="cb9-136"><a href="#cb9-136"></a>      m[<span class="dv">1</span>]*l1 + m[<span class="dv">2</span>]*l2 +</span>
<span id="cb9-137"><a href="#cb9-137"></a>      (b[<span class="dv">1</span>] * erx_srp0 + b[<span class="dv">2</span>] * erx_srp1 + b[<span class="dv">3</span>] * erx_srp2) +</span>
<span id="cb9-138"><a href="#cb9-138"></a>      (b[<span class="dv">4</span>]*er_r_srp1 + b[<span class="dv">5</span>]*er_r_srp2) +</span>
<span id="cb9-139"><a href="#cb9-139"></a>      <span class="co">// b[6] * (1 - ed) + </span></span>
<span id="cb9-140"><a href="#cb9-140"></a>      (b[<span class="dv">6</span>]*ed_d_srp1 + b[<span class="dv">7</span>]*ed_d_srp2)  +</span>
<span id="cb9-141"><a href="#cb9-141"></a>      b[<span class="dv">8</span>] * (<span class="dv">1</span> - ef)  ;</span>
<span id="cb9-142"><a href="#cb9-142"></a>    <span class="co">// f = 1</span></span>
<span id="cb9-143"><a href="#cb9-143"></a>    eta_f_1   =  a0 +</span>
<span id="cb9-144"><a href="#cb9-144"></a>      m[<span class="dv">1</span>]*l1 + m[<span class="dv">2</span>]*l2 +</span>
<span id="cb9-145"><a href="#cb9-145"></a>      (b[<span class="dv">1</span>] * erx_srp0 + b[<span class="dv">2</span>] * erx_srp1 + b[<span class="dv">3</span>] * erx_srp2) +</span>
<span id="cb9-146"><a href="#cb9-146"></a>      (b[<span class="dv">4</span>]*er_r_srp1 + b[<span class="dv">5</span>]*er_r_srp2) +</span>
<span id="cb9-147"><a href="#cb9-147"></a>      <span class="co">// b[6] * (1 - ed) + </span></span>
<span id="cb9-148"><a href="#cb9-148"></a>      (b[<span class="dv">6</span>]*ed_d_srp1 + b[<span class="dv">7</span>]*ed_d_srp2)  +</span>
<span id="cb9-149"><a href="#cb9-149"></a>      <span class="co">// note the use of ef here and not ef_f</span></span>
<span id="cb9-150"><a href="#cb9-150"></a>      b[<span class="dv">8</span>] * (<span class="dv">1</span> - ef) + (b[<span class="dv">9</span>]*ef);</span>
<span id="cb9-151"><a href="#cb9-151"></a></span>
<span id="cb9-152"><a href="#cb9-152"></a>  }</span>
<span id="cb9-153"><a href="#cb9-153"></a></span>
<span id="cb9-154"><a href="#cb9-154"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The model is fitted to a large dataset and the posterior summarised to determine if the parameter estimates approximate the known values.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>There are some terms in the model that under ‘ideal’ situation, i.e.&nbsp;where all patients are revealed as initially intended, that may cause estimation problems. These issues can manifest as sluggish MCMC or weird <code>NA</code> terms appearing in the regression results. In general an <code>NA</code> in the regression results from <code>lm</code> means that the coefficient is not estimable. This can happen due to exact collinearity, e.g.&nbsp;when Q3 = a Q1 + b Q2 + c for some a, b and c, but, it can also happen due to not having enough observations to estimate the relevant parameters (e.g.&nbsp;if p &gt;&gt; n). If you predictors are categorical and you’re adding interaction terms, an <code>NA</code> can also mean that there are no observations with that combination of levels of the factors.</p>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>m4 <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">cmdstan_model</span>(<span class="st">"stan/model-sim-04.stan"</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb10-4"><a href="#cb10-4"></a></span>
<span id="cb10-5"><a href="#cb10-5"></a>sim_spec <span class="ot">&lt;-</span> roadmap.data<span class="sc">::</span><span class="fu">get_sim_spec</span>()</span>
<span id="cb10-6"><a href="#cb10-6"></a>sim_spec<span class="sc">$</span>a0  <span class="ot">&lt;-</span> <span class="fu">qlogis</span>(<span class="fl">0.65</span>)</span>
<span id="cb10-7"><a href="#cb10-7"></a>sim_spec<span class="sc">$</span>m[<span class="st">"l1"</span>] <span class="ot">&lt;-</span> <span class="fl">0.57</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>sim_spec<span class="sc">$</span>m[<span class="st">"l2"</span>] <span class="ot">&lt;-</span> <span class="fl">0.64</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>sim_spec<span class="sc">$</span>b[<span class="st">"erx-r0"</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.1</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>sim_spec<span class="sc">$</span>b[<span class="st">"erx-r1"</span>] <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb10-11"><a href="#cb10-11"></a>sim_spec<span class="sc">$</span>b[<span class="st">"erx-r2"</span>] <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb10-12"><a href="#cb10-12"></a>sim_spec<span class="sc">$</span>b[<span class="st">"r1"</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.6931472</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>sim_spec<span class="sc">$</span>b[<span class="st">"r2"</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.6931472</span></span>
<span id="cb10-14"><a href="#cb10-14"></a>sim_spec<span class="sc">$</span>b[<span class="st">"r1d"</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.6931472</span></span>
<span id="cb10-15"><a href="#cb10-15"></a>sim_spec<span class="sc">$</span>b[<span class="st">"r2d"</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.6931472</span></span>
<span id="cb10-16"><a href="#cb10-16"></a>sim_spec<span class="sc">$</span>b[<span class="st">"efx"</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.2</span></span>
<span id="cb10-17"><a href="#cb10-17"></a>sim_spec<span class="sc">$</span>b[<span class="st">"f"</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.6931472</span></span>
<span id="cb10-18"><a href="#cb10-18"></a></span>
<span id="cb10-19"><a href="#cb10-19"></a></span>
<span id="cb10-20"><a href="#cb10-20"></a>ll <span class="ot">&lt;-</span> roadmap.data<span class="sc">::</span><span class="fu">get_trial_data</span>(<span class="at">N =</span> <span class="fl">2e6</span>, <span class="at">sim_spec =</span> sim_spec)</span>
<span id="cb10-21"><a href="#cb10-21"></a>lsd <span class="ot">&lt;-</span> roadmap.data<span class="sc">::</span><span class="fu">get_stan_data</span>(ll<span class="sc">$</span>d)</span>
<span id="cb10-22"><a href="#cb10-22"></a></span>
<span id="cb10-23"><a href="#cb10-23"></a>d <span class="ot">&lt;-</span> <span class="fu">copy</span>(ll<span class="sc">$</span>d)</span>
<span id="cb10-24"><a href="#cb10-24"></a>d_s <span class="ot">&lt;-</span> <span class="fu">copy</span>(lsd<span class="sc">$</span>d_s)</span>
<span id="cb10-25"><a href="#cb10-25"></a>ld <span class="ot">&lt;-</span> lsd<span class="sc">$</span>ld</span>
<span id="cb10-26"><a href="#cb10-26"></a></span>
<span id="cb10-27"><a href="#cb10-27"></a>f1 <span class="ot">&lt;-</span> m4<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb10-28"><a href="#cb10-28"></a>  ld, <span class="at">iter_warmup =</span> <span class="dv">1000</span>, <span class="at">iter_sampling =</span> <span class="dv">2000</span>,</span>
<span id="cb10-29"><a href="#cb10-29"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>, <span class="at">chains =</span> <span class="dv">2</span>, <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">show_exceptions =</span> F,</span>
<span id="cb10-30"><a href="#cb10-30"></a>  <span class="at">max_treedepth =</span> <span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 2 parallel chains...

Chain 1 finished in 1.5 seconds.
Chain 2 finished in 1.6 seconds.

Both chains finished successfully.
Mean chain execution time: 1.5 seconds.
Total execution time: 1.6 seconds.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co"># See note above. edx is dropped from the model as it is collinear with</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="co"># srp1 and srp2 and leads to an estimation issue.</span></span>
<span id="cb12-3"><a href="#cb12-3"></a></span>
<span id="cb12-4"><a href="#cb12-4"></a>f2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> l1 <span class="sc">+</span> l2 <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>            erx<span class="sc">:</span>srp0 <span class="sc">+</span> erx<span class="sc">:</span>srp1 <span class="sc">+</span> erx<span class="sc">:</span>srp2 <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>            er<span class="sc">:</span>r<span class="sc">:</span>srp1 <span class="sc">+</span> er<span class="sc">:</span>r<span class="sc">:</span>srp2 <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7"></a>            ed<span class="sc">:</span>d<span class="sc">:</span>srp1 <span class="sc">+</span> ed<span class="sc">:</span>d<span class="sc">:</span>srp2 <span class="sc">+</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>            efx <span class="sc">+</span> ef<span class="sc">:</span>f,  </span>
<span id="cb12-9"><a href="#cb12-9"></a>          <span class="at">data =</span> d, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb12-10"><a href="#cb12-10"></a></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="co"># summary(f2)</span></span>
<span id="cb12-12"><a href="#cb12-12"></a></span>
<span id="cb12-13"><a href="#cb12-13"></a><span class="co"># dtmp &lt;- data.table(model.matrix(f2)) </span></span>
<span id="cb12-14"><a href="#cb12-14"></a><span class="co"># dtmp &lt;- cbind(model.matrix(f2), tot = 0)</span></span>
<span id="cb12-15"><a href="#cb12-15"></a><span class="co"># pracma::rref(dtmp)</span></span>
<span id="cb12-16"><a href="#cb12-16"></a><span class="co"># d_s</span></span>
<span id="cb12-17"><a href="#cb12-17"></a></span>
<span id="cb12-18"><a href="#cb12-18"></a><span class="co"># dtmp &lt;- data.table(model.matrix(f2))</span></span>
<span id="cb12-19"><a href="#cb12-19"></a><span class="co"># </span></span>
<span id="cb12-20"><a href="#cb12-20"></a><span class="co"># rref(dtmp)</span></span>
<span id="cb12-21"><a href="#cb12-21"></a><span class="co"># dtmp.mean &lt;- apply(dtmp, 2, mean)</span></span>
<span id="cb12-22"><a href="#cb12-22"></a><span class="co"># dtmp &lt;- sweep(dtmp, 2, dtmp.mean)</span></span>
<span id="cb12-23"><a href="#cb12-23"></a><span class="co"># </span></span>
<span id="cb12-24"><a href="#cb12-24"></a><span class="co"># f3 &lt;- prcomp(dtmp)</span></span>
<span id="cb12-25"><a href="#cb12-25"></a><span class="co"># print(f3)</span></span>
<span id="cb12-26"><a href="#cb12-26"></a><span class="co"># </span></span>
<span id="cb12-27"><a href="#cb12-27"></a><span class="co"># # Fairly unsafe - checking for full rank on removal of each var</span></span>
<span id="cb12-28"><a href="#cb12-28"></a><span class="co"># linearly_dep_cols(f2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The parameter estimates align reasonably well to the simulation parameters used in the linear predictor:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>post1 <span class="ot">&lt;-</span> <span class="fu">data.table</span>(f1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="fu">c</span>(<span class="st">"a0"</span>, <span class="st">"m"</span>, <span class="st">"b"</span>)), <span class="at">format =</span> <span class="st">"matrix"</span>))</span>
<span id="cb13-2"><a href="#cb13-2"></a>cf <span class="ot">&lt;-</span> <span class="fu">coef</span>(f2)</span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="fu">round</span>(<span class="fu">rbind</span>(</span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="st">"Simulation parameters"</span> <span class="ot">=</span> <span class="fu">c</span>(sim_spec<span class="sc">$</span>a0, sim_spec<span class="sc">$</span>m, sim_spec<span class="sc">$</span>b),</span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="st">"Posterior means"</span> <span class="ot">=</span> <span class="fu">colMeans</span>(post1),</span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="st">"Max likelihood"</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb13-8"><a href="#cb13-8"></a>    cf[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>], </span>
<span id="cb13-9"><a href="#cb13-9"></a>    cf[<span class="st">"erx:srp0"</span>], cf[<span class="st">"erx:srp1"</span>], cf[<span class="st">"erx:srp2"</span>], </span>
<span id="cb13-10"><a href="#cb13-10"></a>    cf[<span class="st">"srp1:er:r"</span>], cf[<span class="st">"srp2:er:r"</span>] , </span>
<span id="cb13-11"><a href="#cb13-11"></a>    cf[<span class="st">"srp1:ed:d"</span>], cf[<span class="st">"srp2:ed:d"</span>],</span>
<span id="cb13-12"><a href="#cb13-12"></a>    cf[<span class="st">"efx"</span>], cf[<span class="st">"ef:f"</span>]</span>
<span id="cb13-13"><a href="#cb13-13"></a>  )</span>
<span id="cb13-14"><a href="#cb13-14"></a>), <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                                 l1     l2  erx-r0 erx-r1 erx-r2      r1
Simulation parameters 0.6190 0.5700 0.6400 -0.1000 0.1000 0.0500 -0.6931
Posterior means       0.6254 0.5600 0.6343 -0.1091 0.0841 0.0574 -0.7023
Max likelihood        0.6257 0.5596 0.6342 -0.1095 0.0839 0.0572 -0.7023
                           r2     r1d     r2d     efx       f
Simulation parameters -0.6931 -0.6931 -0.6931 -0.2000 -0.6931
Posterior means       -0.6928 -0.6787 -0.7005 -0.1975 -0.6914
Max likelihood        -0.6926 -0.6787 -0.7006 -0.1976 -0.6914</code></pre>
</div>
</div>
</section>
<section id="estimation---g-computation" class="level2">
<h2 class="anchored" data-anchor-id="estimation---g-computation">Estimation - G-computation</h2>
<p>This section is now incomplete due to the revised model specification.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>Calculations based on Bayesian model are complicated by virtue of use of binomial instead of bernoulli likelihood. To deal with this, we weight the log-odds contributions by the number of trials associated with each unique combination.</p>
</div>
</div>
</div>
<p>Predictions on log-odds scale:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>eta_r_0 <span class="ot">&lt;-</span> f1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"eta_r_0"</span>), <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb15-2"><a href="#cb15-2"></a>eta_r_1 <span class="ot">&lt;-</span> f1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"eta_r_1"</span>), <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb15-3"><a href="#cb15-3"></a>eta_d_0 <span class="ot">&lt;-</span> f1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"eta_d_0"</span>), <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb15-4"><a href="#cb15-4"></a>eta_d_1 <span class="ot">&lt;-</span> f1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"eta_d_1"</span>), <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb15-5"><a href="#cb15-5"></a>eta_f_0 <span class="ot">&lt;-</span> f1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"eta_f_0"</span>), <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb15-6"><a href="#cb15-6"></a>eta_f_1 <span class="ot">&lt;-</span> f1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"eta_f_1"</span>), <span class="at">format =</span> <span class="st">"matrix"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The G-formula allows you to go from a conditional estimate to a marginal one via standardisation or other means.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># g-comp - calculations are complicated by virtue of use of binomial</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="co"># instead of bernoulli model. Approach is to weight the log-odds contributions</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="co"># by the number of trials associated with each unique combination.</span></span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a>max_rows <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb16-6"><a href="#cb16-6"></a></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="co"># Compute the effect of revision</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>b_r <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="fu">min</span>(<span class="fu">nrow</span>(eta_r_0), max_rows)), <span class="cf">function</span>(ii){</span>
<span id="cb16-9"><a href="#cb16-9"></a>  </span>
<span id="cb16-10"><a href="#cb16-10"></a>  <span class="co"># columns in eta_r_0 correspond to the covariate groups, i.e. the rows in d_s</span></span>
<span id="cb16-11"><a href="#cb16-11"></a>  </span>
<span id="cb16-12"><a href="#cb16-12"></a>  <span class="co"># The repitition gives the right contribution (weight) for each covariate </span></span>
<span id="cb16-13"><a href="#cb16-13"></a>  <span class="co"># combination i.e. each column (covariate combination) is replicated by </span></span>
<span id="cb16-14"><a href="#cb16-14"></a>  <span class="co"># the number of pts with this covariate combination. </span></span>
<span id="cb16-15"><a href="#cb16-15"></a>  </span>
<span id="cb16-16"><a href="#cb16-16"></a>  <span class="co"># This first one is averaged across both non-reveal and revealed. It is not</span></span>
<span id="cb16-17"><a href="#cb16-17"></a>  <span class="co"># what we want</span></span>
<span id="cb16-18"><a href="#cb16-18"></a>  lo_0 <span class="ot">&lt;-</span> eta_r_0[ii, <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d_s), <span class="at">times =</span> ld<span class="sc">$</span>n)]</span>
<span id="cb16-19"><a href="#cb16-19"></a>  lo_1 <span class="ot">&lt;-</span> eta_r_1[ii, <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d_s), <span class="at">times =</span> ld<span class="sc">$</span>n)]</span>
<span id="cb16-20"><a href="#cb16-20"></a>  mu_r <span class="ot">=</span> <span class="fu">mean</span>(lo_1 <span class="sc">-</span> lo_0)</span>
<span id="cb16-21"><a href="#cb16-21"></a>  </span>
<span id="cb16-22"><a href="#cb16-22"></a>  <span class="co"># Should be no effect of rev in those that were not rand to surg</span></span>
<span id="cb16-23"><a href="#cb16-23"></a>  <span class="co"># idx &lt;- d_s[er == 0 , which = T]</span></span>
<span id="cb16-24"><a href="#cb16-24"></a>  <span class="co"># lo_0_erx &lt;- eta_r_0[ii, rep(idx, times = ld$n[idx])]</span></span>
<span id="cb16-25"><a href="#cb16-25"></a>  <span class="co"># lo_1_erx &lt;- eta_r_1[ii, rep(idx, times = ld$n[idx])]</span></span>
<span id="cb16-26"><a href="#cb16-26"></a>  <span class="co"># mu_r_erx &lt;- sum(lo_1_erx - lo_0_erx) / sum(ld$n[idx])</span></span>
<span id="cb16-27"><a href="#cb16-27"></a>  </span>
<span id="cb16-28"><a href="#cb16-28"></a>  <span class="co"># Finally, these give the effect in those revealed to surgery domain. This</span></span>
<span id="cb16-29"><a href="#cb16-29"></a>  <span class="co"># is what we want.</span></span>
<span id="cb16-30"><a href="#cb16-30"></a>  idx <span class="ot">&lt;-</span> d_s[er <span class="sc">==</span> <span class="dv">1</span> , which <span class="ot">=</span> T]</span>
<span id="cb16-31"><a href="#cb16-31"></a>  lo_0_erx <span class="ot">&lt;-</span> eta_r_0[ii, <span class="fu">rep</span>(idx, <span class="at">times =</span> ld<span class="sc">$</span>n[idx])]</span>
<span id="cb16-32"><a href="#cb16-32"></a>  lo_1_erx <span class="ot">&lt;-</span> eta_r_1[ii, <span class="fu">rep</span>(idx, <span class="at">times =</span> ld<span class="sc">$</span>n[idx])]</span>
<span id="cb16-33"><a href="#cb16-33"></a>  mu_r_er <span class="ot">&lt;-</span> <span class="fu">sum</span>(lo_1_erx <span class="sc">-</span> lo_0_erx) <span class="sc">/</span> <span class="fu">sum</span>(ld<span class="sc">$</span>n[idx])</span>
<span id="cb16-34"><a href="#cb16-34"></a>  </span>
<span id="cb16-35"><a href="#cb16-35"></a>  <span class="co"># avg effect then effect in non-reveal and reveal</span></span>
<span id="cb16-36"><a href="#cb16-36"></a>  <span class="fu">c</span>(<span class="st">"mu_r"</span> <span class="ot">=</span> mu_r, </span>
<span id="cb16-37"><a href="#cb16-37"></a>    <span class="co"># "mu_r_erx" = mu_r_erx, </span></span>
<span id="cb16-38"><a href="#cb16-38"></a>    <span class="st">"mu_r_er"</span> <span class="ot">=</span> mu_r_er)</span>
<span id="cb16-39"><a href="#cb16-39"></a>}, <span class="at">mc.cores =</span> <span class="dv">10</span>))</span>
<span id="cb16-40"><a href="#cb16-40"></a></span>
<span id="cb16-41"><a href="#cb16-41"></a></span>
<span id="cb16-42"><a href="#cb16-42"></a><span class="co"># Compute the effect of duration for the pt that received one-stage</span></span>
<span id="cb16-43"><a href="#cb16-43"></a><span class="co"># and for those that received two-stage surgery.</span></span>
<span id="cb16-44"><a href="#cb16-44"></a>b_d <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="fu">min</span>(<span class="fu">nrow</span>(eta_d_0), max_rows)), <span class="cf">function</span>(ii){</span>
<span id="cb16-45"><a href="#cb16-45"></a>  </span>
<span id="cb16-46"><a href="#cb16-46"></a>  lo_0 <span class="ot">&lt;-</span> eta_d_0[ii, <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d_s), <span class="at">times =</span> ld<span class="sc">$</span>n)]</span>
<span id="cb16-47"><a href="#cb16-47"></a>  lo_1 <span class="ot">&lt;-</span> eta_d_1[ii, <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d_s), <span class="at">times =</span> ld<span class="sc">$</span>n)]</span>
<span id="cb16-48"><a href="#cb16-48"></a></span>
<span id="cb16-49"><a href="#cb16-49"></a>  <span class="co"># stratification, silo/revision type that actually took place</span></span>
<span id="cb16-50"><a href="#cb16-50"></a>  <span class="co"># idx &lt;- d_s[ed == 0 &amp; srp2 == 0, which = T]</span></span>
<span id="cb16-51"><a href="#cb16-51"></a>  <span class="co"># lo_0_edx_srp1 &lt;- eta_d_0[ii, rep(idx, times = ld$n[idx])]</span></span>
<span id="cb16-52"><a href="#cb16-52"></a>  <span class="co"># lo_1_edx_srp1 &lt;- eta_d_1[ii, rep(idx, times = ld$n[idx])]</span></span>
<span id="cb16-53"><a href="#cb16-53"></a>  <span class="co"># mu_d_edx_srp1 &lt;- sum(lo_1_edx_srp1 - lo_0_edx_srp1) / sum(ld$n[idx])</span></span>
<span id="cb16-54"><a href="#cb16-54"></a>  <span class="co"># </span></span>
<span id="cb16-55"><a href="#cb16-55"></a>  <span class="co"># idx &lt;- d_s[ed == 0 &amp; srp2 == 1, which = T]</span></span>
<span id="cb16-56"><a href="#cb16-56"></a>  <span class="co"># lo_0_edx_srp2 &lt;- eta_d_0[ii, rep(idx, times = ld$n[idx])]</span></span>
<span id="cb16-57"><a href="#cb16-57"></a>  <span class="co"># lo_1_edx_srp2 &lt;- eta_d_1[ii, rep(idx, times = ld$n[idx])]</span></span>
<span id="cb16-58"><a href="#cb16-58"></a>  <span class="co"># mu_d_edx_srp2 &lt;- sum(lo_1_edx_srp2 - lo_0_edx_srp2) / sum(ld$n[idx])</span></span>
<span id="cb16-59"><a href="#cb16-59"></a></span>
<span id="cb16-60"><a href="#cb16-60"></a>  idx <span class="ot">&lt;-</span> d_s[ed <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> srp2 <span class="sc">==</span> <span class="dv">0</span>, which <span class="ot">=</span> T]</span>
<span id="cb16-61"><a href="#cb16-61"></a>  lo_0_ed_srp1 <span class="ot">&lt;-</span> eta_d_0[ii, <span class="fu">rep</span>(idx, <span class="at">times =</span> ld<span class="sc">$</span>n[idx])]</span>
<span id="cb16-62"><a href="#cb16-62"></a>  lo_1_ed_srp1 <span class="ot">&lt;-</span> eta_d_1[ii, <span class="fu">rep</span>(idx, <span class="at">times =</span> ld<span class="sc">$</span>n[idx])]</span>
<span id="cb16-63"><a href="#cb16-63"></a>  mu_d_ed_srp1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(lo_1_ed_srp1 <span class="sc">-</span> lo_0_ed_srp1) <span class="sc">/</span> <span class="fu">sum</span>(ld<span class="sc">$</span>n[idx])</span>
<span id="cb16-64"><a href="#cb16-64"></a></span>
<span id="cb16-65"><a href="#cb16-65"></a>  idx <span class="ot">&lt;-</span> d_s[ed <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> srp2 <span class="sc">==</span> <span class="dv">1</span>, which <span class="ot">=</span> T]</span>
<span id="cb16-66"><a href="#cb16-66"></a>  lo_0_ed_srp2 <span class="ot">&lt;-</span> eta_d_0[ii, <span class="fu">rep</span>(idx, <span class="at">times =</span> ld<span class="sc">$</span>n[idx])]</span>
<span id="cb16-67"><a href="#cb16-67"></a>  lo_1_ed_srp2 <span class="ot">&lt;-</span> eta_d_1[ii, <span class="fu">rep</span>(idx, <span class="at">times =</span> ld<span class="sc">$</span>n[idx])]</span>
<span id="cb16-68"><a href="#cb16-68"></a>  mu_d_ed_srp2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(lo_1_ed_srp2 <span class="sc">-</span> lo_0_ed_srp2) <span class="sc">/</span> <span class="fu">sum</span>(ld<span class="sc">$</span>n[idx])</span>
<span id="cb16-69"><a href="#cb16-69"></a></span>
<span id="cb16-70"><a href="#cb16-70"></a>  <span class="fu">c</span>(<span class="st">"mu_d"</span> <span class="ot">=</span> <span class="fu">mean</span>(lo_1 <span class="sc">-</span> lo_0), </span>
<span id="cb16-71"><a href="#cb16-71"></a>    <span class="co"># you need to base the mean on the n that were used in the strata</span></span>
<span id="cb16-72"><a href="#cb16-72"></a>    <span class="co"># "mu_d_edx_srp1" = mu_d_edx_srp1,  "mu_d_edx_srp2" = mu_d_edx_srp2,</span></span>
<span id="cb16-73"><a href="#cb16-73"></a>    <span class="st">"mu_d_ed_srp1"</span> <span class="ot">=</span> mu_d_ed_srp1, <span class="st">"mu_d_ed_srp2"</span> <span class="ot">=</span> mu_d_ed_srp2</span>
<span id="cb16-74"><a href="#cb16-74"></a>    )</span>
<span id="cb16-75"><a href="#cb16-75"></a>  </span>
<span id="cb16-76"><a href="#cb16-76"></a>}, <span class="at">mc.cores =</span> <span class="dv">10</span>))</span>
<span id="cb16-77"><a href="#cb16-77"></a></span>
<span id="cb16-78"><a href="#cb16-78"></a><span class="co"># Compute the effect of AB choice.</span></span>
<span id="cb16-79"><a href="#cb16-79"></a>b_f <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="fu">min</span>(<span class="fu">nrow</span>(eta_f_0), max_rows)), <span class="cf">function</span>(ii){</span>
<span id="cb16-80"><a href="#cb16-80"></a>  </span>
<span id="cb16-81"><a href="#cb16-81"></a>  <span class="co"># Avg effect of rif - what is the effect of rif in the sample population</span></span>
<span id="cb16-82"><a href="#cb16-82"></a>  <span class="co"># Might be wrong, but don't believe this is a meaningful/useful quantity.</span></span>
<span id="cb16-83"><a href="#cb16-83"></a>  lo_0 <span class="ot">&lt;-</span> eta_f_0[ii, <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d_s), <span class="at">times =</span> ld<span class="sc">$</span>n)]</span>
<span id="cb16-84"><a href="#cb16-84"></a>  lo_1 <span class="ot">&lt;-</span> eta_f_1[ii, <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d_s), <span class="at">times =</span> ld<span class="sc">$</span>n)]</span>
<span id="cb16-85"><a href="#cb16-85"></a>  mu_f <span class="ot">&lt;-</span> <span class="fu">mean</span>(lo_1 <span class="sc">-</span> lo_0)</span>
<span id="cb16-86"><a href="#cb16-86"></a>  </span>
<span id="cb16-87"><a href="#cb16-87"></a>  <span class="co"># Should be no effect of rif in those that were not rand to choice</span></span>
<span id="cb16-88"><a href="#cb16-88"></a>  <span class="co"># idx &lt;- d_s[ef == 0 , which = T]</span></span>
<span id="cb16-89"><a href="#cb16-89"></a>  <span class="co"># lo_0_efx &lt;- eta_f_0[ii, rep(idx, times = ld$n[idx])]</span></span>
<span id="cb16-90"><a href="#cb16-90"></a>  <span class="co"># lo_1_efx &lt;- eta_f_1[ii, rep(idx, times = ld$n[idx])]</span></span>
<span id="cb16-91"><a href="#cb16-91"></a>  <span class="co"># mu_f_efx &lt;- sum(lo_1_efx - lo_0_efx) / sum(ld$n[idx])</span></span>
<span id="cb16-92"><a href="#cb16-92"></a></span>
<span id="cb16-93"><a href="#cb16-93"></a>  <span class="co"># Effect of rif in those rand to choice domain</span></span>
<span id="cb16-94"><a href="#cb16-94"></a>  idx <span class="ot">&lt;-</span> d_s[ef <span class="sc">==</span> <span class="dv">1</span> , which <span class="ot">=</span> T]</span>
<span id="cb16-95"><a href="#cb16-95"></a>  lo_0_ef <span class="ot">&lt;-</span> eta_f_0[ii, <span class="fu">rep</span>(idx, <span class="at">times =</span> ld<span class="sc">$</span>n[idx])]</span>
<span id="cb16-96"><a href="#cb16-96"></a>  lo_1_ef <span class="ot">&lt;-</span> eta_f_1[ii, <span class="fu">rep</span>(idx, <span class="at">times =</span> ld<span class="sc">$</span>n[idx])]</span>
<span id="cb16-97"><a href="#cb16-97"></a>  mu_f_ef <span class="ot">&lt;-</span> <span class="fu">sum</span>(lo_1_ef <span class="sc">-</span> lo_0_ef) <span class="sc">/</span> <span class="fu">sum</span>(ld<span class="sc">$</span>n[idx])</span>
<span id="cb16-98"><a href="#cb16-98"></a>  </span>
<span id="cb16-99"><a href="#cb16-99"></a>  <span class="fu">c</span>(<span class="st">"mu_f"</span> <span class="ot">=</span> mu_f, </span>
<span id="cb16-100"><a href="#cb16-100"></a>    <span class="co"># "mu_f_efx" = mu_f_efx, </span></span>
<span id="cb16-101"><a href="#cb16-101"></a>    <span class="st">"mu_f_ef"</span> <span class="ot">=</span> mu_f_ef)</span>
<span id="cb16-102"><a href="#cb16-102"></a>}, <span class="at">mc.cores =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following provides the results and also comparisons to combinations of parameters used in data simulation.</p>
<p>For the surgery domain, the comparison of interest is dair (ref) vs revision, which can be obtained by averaging over the distribution of surgery type that took place. The revision effects are silo-specific in that only the late silo is randomised which we obtain by producing a conditional treatment effect by stratifying on the reveal status (<code>er</code>).</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>I don’t believe that we currently need to worry about differential selection (<span class="math inline">\(\mathbb{P}(S=s|G=1)\ne\mathbb{P}(S=s|G=2)\)</span>) because only one silo is contributing to the randomised comparison and I think we are restricting to that silo by virtue of conditiong on <code>er</code>.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># dair (ref)  vs revision (of any form)</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="fu">avg_comparisons</span>(f2, <span class="at">variables =</span> <span class="st">"r"</span>, <span class="at">comparison =</span> <span class="st">"lnor"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Term              Contrast Estimate Std. Error    z Pr(&gt;|z|)   S  2.5 % 97.5 %
    r ln(odds(1) / odds(0))    -0.17    0.00118 -144   &lt;0.001 Inf -0.173 -0.168

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high 
Type:  response </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># The above call to avg_comparisons is equivalent to:</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="co"># w_eta_r0 &lt;- sweep(eta_r0, 1, ld$n, "*")</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>d_new <span class="ot">&lt;-</span> <span class="fu">copy</span>(d)</span>
<span id="cb19-4"><a href="#cb19-4"></a>lo <span class="ot">&lt;-</span> <span class="fu">copy</span>(d_new[, <span class="at">r :=</span> <span class="dv">0</span>])</span>
<span id="cb19-5"><a href="#cb19-5"></a>d_new <span class="ot">&lt;-</span> <span class="fu">copy</span>(d)</span>
<span id="cb19-6"><a href="#cb19-6"></a>hi <span class="ot">&lt;-</span> <span class="fu">copy</span>(d_new[, <span class="at">r :=</span> <span class="dv">1</span>])</span>
<span id="cb19-7"><a href="#cb19-7"></a>y_lo <span class="ot">&lt;-</span> <span class="fu">predict</span>(f2, <span class="at">newdata =</span> lo)</span>
<span id="cb19-8"><a href="#cb19-8"></a>y_hi <span class="ot">&lt;-</span> <span class="fu">predict</span>(f2, <span class="at">newdata =</span> hi)</span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="fu">mean</span>(y_hi <span class="sc">-</span> y_lo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.170319</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># But we are only interested in the effect of r in the group that were revealed.</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="co"># The following, in avg_comparisons, does not make sense to me. Need to revisit.</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="co"># cmp &lt;- avg_comparisons(f2, newdata = d[er == 1 &amp; r == 1], variables = "r", comparison = "lnor")</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="co"># print(cmp, digits = 6)</span></span>
<span id="cb21-5"><a href="#cb21-5"></a></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="co"># The randomised comparison should approx map to a weighted combination of the pars.</span></span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="co"># The reason that the weights are computed conditional on r == 1 is so that we are</span></span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="co"># weight by the proportion within the revision group that receive each revision type </span></span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="co"># (approx 30% one-stage, 70% two-stage) and not the proportion receiving each revision </span></span>
<span id="cb21-10"><a href="#cb21-10"></a><span class="co"># type over all those that received randomised surgery (approx 50% dair, 15% one, 35% two).</span></span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="fu">mean</span>(d[er <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> r <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(srp1)] <span class="sc">*</span> post1<span class="sc">$</span><span class="st">`</span><span class="at">b[4]</span><span class="st">`</span> <span class="sc">+</span> d[er <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> r <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(srp2)] <span class="sc">*</span> post1<span class="sc">$</span><span class="st">`</span><span class="at">b[5]</span><span class="st">`</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.695645</code></pre>
</div>
</div>
<p>The above series of outputs suggest somewhat that we are able to recover the required parameters using various approaches.</p>
<p>For the choice domain, the comparison of interest is no-rf (ref) vs rif, which can be obtained directly from the parameter estimate that characterised the effects of the randomised comparisons. Choice domain effects reflect an average over the silos since all silos can enter this domain.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># no-rif (ref)  vs rif (of any form)</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="co"># NO - avg_comparisons(f2, variables = "f", comparison = "lnor")</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="co"># We are only interested in the effect of choice for those revealed to choice</span></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="co"># cmp &lt;- avg_comparisons(f2, newdata = d[ef == 1], variables = "f", comparison = "lnor")</span></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="co"># print(cmp, digits = 6)</span></span>
<span id="cb23-6"><a href="#cb23-6"></a></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="co"># colMeans(b_f)</span></span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="co"># And this should just be the same as the coefficient from the model</span></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="fu">mean</span>(post1<span class="sc">$</span><span class="st">`</span><span class="at">b[9]</span><span class="st">`</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.6914353</code></pre>
</div>
</div>
<p>For the duration domain, the comparison of interest can be obtained directly from the parameter estimates that characterised the effects of the randomised comparisons. Duration domain effects are also currently reflecting an average over the silos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># long (ref) vs short (specific to the type of surg recvd - one or two stage)</span></span>
<span id="cb25-2"><a href="#cb25-2"></a></span>
<span id="cb25-3"><a href="#cb25-3"></a>cmp <span class="ot">&lt;-</span> <span class="fu">avg_comparisons</span>(f2, <span class="at">newdata =</span> d[ed <span class="sc">==</span> <span class="dv">1</span> ], <span class="at">variables =</span> <span class="st">"d"</span>, <span class="at">comparison =</span> <span class="st">"lnor"</span>, <span class="at">by =</span> <span class="st">"d"</span>)</span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="fu">print</span>(cmp, <span class="at">digits =</span> <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Term              Contrast d  Estimate Std. Error        z Pr(&gt;|z|)   S
    d ln(odds(1) / odds(0)) 0 -0.656909 0.00421194 -155.963  &lt; 0.001 Inf
    d ln(odds(1) / odds(0)) 1 -0.656735 0.00421091 -155.960  &lt; 0.001 Inf
     2.5 %    97.5 %
 -0.665164 -0.648654
 -0.664988 -0.648481

Columns: term, contrast, d, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high 
Type:  response </code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>cmp <span class="ot">&lt;-</span> <span class="fu">avg_comparisons</span>(f2, <span class="at">newdata =</span> d[ed <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> srp2 <span class="sc">==</span> <span class="dv">1</span>], <span class="at">variables =</span> <span class="st">"d"</span>, <span class="at">comparison =</span> <span class="st">"lnor"</span>)</span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="fu">print</span>(cmp, <span class="at">digits =</span> <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Term              Contrast  Estimate Std. Error        z Pr(&gt;|z|)   S
    d ln(odds(1) / odds(0)) -0.700637   0.005446 -128.652  &lt; 0.001 Inf
     2.5 %    97.5 %
 -0.711311 -0.689963

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high 
Type:  response </code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># colMeans(b_d)</span></span>
<span id="cb29-2"><a href="#cb29-2"></a></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="co"># The randomised comparison should approx map directly to the surg type </span></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="co"># specific pars </span></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="fu">mean</span>(post1<span class="sc">$</span><span class="st">`</span><span class="at">b[6]</span><span class="st">`</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.6786935</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">mean</span>(post1<span class="sc">$</span><span class="st">`</span><span class="at">b[7]</span><span class="st">`</span> ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.7005013</code></pre>
</div>
</div>
<p>Based on the above, we seem to be in the right ballpark.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/github\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>