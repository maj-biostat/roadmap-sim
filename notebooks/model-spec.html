<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.542">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-04-14">

<title>ROADMAP - design notes and simulations - Model specification</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://hypothes.is/embed.js"></script>
<script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>
<script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">ROADMAP - design notes and simulations</span>
    </a>
  </div>
        <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/maj-biostat/roadmap-sim">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/maj-biostat/roadmap-sim/issues">
            Report a Bug
            </a>
          </li>
      </ul>
    </div>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/population-structure.html">Design</a></li><li class="breadcrumb-item"><a href="../notebooks/model-spec.html">Model specification</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Design</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/population-structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Population structure</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/model-spec.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Model specification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/decision-rules.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Decision rules</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/simulation-pars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulation setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/trial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulated trial data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/model-implementation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model implementation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/example-trials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Example trials</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/sim-design1-results.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulation results 1</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/sim-design3-results.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulation results 3</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/design-notes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Design Notes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/misc-notes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reminders</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#primary-outcome" id="toc-primary-outcome" class="nav-link active" data-scroll-target="#primary-outcome">Primary outcome</a></li>
  <li><a href="#early-infection" id="toc-early-infection" class="nav-link" data-scroll-target="#early-infection">Early infection</a></li>
  <li><a href="#late-infection" id="toc-late-infection" class="nav-link" data-scroll-target="#late-infection">Late infection</a></li>
  <li><a href="#chronic-infection" id="toc-chronic-infection" class="nav-link" data-scroll-target="#chronic-infection">Chronic infection</a></li>
  <li><a href="#causal-structure" id="toc-causal-structure" class="nav-link" data-scroll-target="#causal-structure">Causal structure</a></li>
  <li><a href="#research-questions" id="toc-research-questions" class="nav-link" data-scroll-target="#research-questions">Research questions</a></li>
  <li><a href="#sec-model-spec" id="toc-sec-model-spec" class="nav-link" data-scroll-target="#sec-model-spec">Model specification</a></li>
  <li><a href="#examples" id="toc-examples" class="nav-link" data-scroll-target="#examples">Examples</a>
  <ul>
  <li><a href="#randomised-surgical-treatment" id="toc-randomised-surgical-treatment" class="nav-link" data-scroll-target="#randomised-surgical-treatment">Randomised surgical treatment</a></li>
  <li><a href="#non-randomised-surgical-treatment" id="toc-non-randomised-surgical-treatment" class="nav-link" data-scroll-target="#non-randomised-surgical-treatment">Non-randomised surgical treatment</a></li>
  </ul></li>
  <li><a href="#treatment-effects" id="toc-treatment-effects" class="nav-link" data-scroll-target="#treatment-effects">Treatment effects</a></li>
  <li><a href="#priors" id="toc-priors" class="nav-link" data-scroll-target="#priors">Priors</a>
  <ul>
  <li><a href="#intercepts" id="toc-intercepts" class="nav-link" data-scroll-target="#intercepts">Intercepts</a></li>
  <li><a href="#other-covariates" id="toc-other-covariates" class="nav-link" data-scroll-target="#other-covariates">Other covariates</a></li>
  <li><a href="#treatment-effects-1" id="toc-treatment-effects-1" class="nav-link" data-scroll-target="#treatment-effects-1">Treatment effects</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/population-structure.html">Design</a></li><li class="breadcrumb-item"><a href="../notebooks/model-spec.html">Model specification</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Model specification</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 14, 2024</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">April 12, 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<div class="cell">

</div>
<section id="primary-outcome" class="level2">
<h2 class="anchored" data-anchor-id="primary-outcome">Primary outcome</h2>
<p>The primary outcome is treatment success at 12 months post platform entry, defined as <strong>all of</strong>:</p>
<ol type="1">
<li>Alive</li>
<li>Clinical cure (no clinical or microbiological evidence of infection)</li>
<li>No ongoing use of antibiotics for the index joint; and</li>
<li>The prosthesis present after the initial management strategy is complete (destination prosthesis) still in place</li>
</ol>
<p>referred to as ‘treatment success’.</p>
</section>
<section id="early-infection" class="level2">
<h2 class="anchored" data-anchor-id="early-infection">Early infection</h2>
<p>Patients with early stage infection are not revealed<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> to the surgical domain. The surgical intervention will usually be dair for which 12 weeks of antibiotics are recommended. There are, however, instances where early stage infection patients will receive a surgical intervention and these patients will therefore be able to enter the duration domain and receive randomised antibiotic duration. These patients will also enter the choice domain.</p>
</section>
<section id="late-infection" class="level2">
<h2 class="anchored" data-anchor-id="late-infection">Late infection</h2>
<p>Patients with late infection enter all domains, but with some restrictions. They are randomised to dair vs revision in the surgical domain. Patients allocated to revision will receive a one or two-stage procedure. Both the planned surgery (one-stage/two-stage) and the surgery actually performed should be captured – the former should be recorded at the time of randomisation. These patients will also enter the choice domain.</p>
</section>
<section id="chronic-infection" class="level2">
<h2 class="anchored" data-anchor-id="chronic-infection">Chronic infection</h2>
<p>Patients with chronic stage infection are not randomised into the surgical domain, but they can enter into the duration domain based on the type of surgery they receive. These patients will also enter the choice domain.</p>
</section>
<section id="causal-structure" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="causal-structure">Causal structure</h2>
<p>We assume the following DAG, which is a simplified causal representation of how patients reach their treatment status across the domains:</p>
<div class="cell page-columns page-full" data-layout-align="default">
<div class="cell-output-display page-columns page-full">
<div id="fig-modspec-1" class="quarto-figure quarto-figure-center quarto-float anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-modspec-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-modspec-1">%%{
  init:{
    "flowchart":{"htmlLabels": "true"},
    "securityLevel": "loose",
    "theme": "base"
}}%%
flowchart LR
  ER(E&lt;sub&gt;R) --&gt; RA(R&lt;sub&gt;A) 
  ER --&gt; SR(S&lt;sub&gt;R)
  ED(E&lt;sub&gt;D) --&gt; DA(D&lt;sub&gt;A) 
  SR --&gt; RA 
  SD(S&lt;sub&gt;D) --&gt; DA 
  R --&gt; RA
  RA --&gt; RP(R&lt;sub&gt;P) 
  SRP(S&lt;sub&gt;R&lt;sub&gt;P) --&gt; RP
  RA --&gt; Y
  RP --&gt; ED
  D --&gt; DA(D&lt;sub&gt;A)
  DA --&gt; Y
  F --&gt; FA(F&lt;sub&gt;A)
  EF(E&lt;sub&gt;F) --&gt; FA
  SF(S&lt;sub&gt;F) --&gt; FA 
  FA --&gt; Y
  UER((U&lt;sub&gt;E&lt;sub&gt;R)) -.-&gt; ER
  UED((U&lt;sub&gt;E&lt;sub&gt;D)) -.-&gt; ED
  UEF((U&lt;sub&gt;E&lt;sub&gt;F)) -.-&gt; EF
  UF((U&lt;sub&gt;F)) -.-&gt; F
  URP((U&lt;sub&gt;R&lt;sub&gt;P)) -.-&gt; SRP
  UD((U&lt;sub&gt;D)) -.-&gt; D
  USR((U&lt;sub&gt;S&lt;sub&gt;R)) -.-&gt; SR
  UR((U&lt;sub&gt;R)) -.-&gt; R
  USD((U&lt;sub&gt;S&lt;sub&gt;D)) -.-&gt; SD
  USF((U&lt;sub&gt;S&lt;sub&gt;F)) -.-&gt; SF
  UY((U&lt;sub&gt;Y)) -.-&gt; Y
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-modspec-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Assumed causal diagram representing the (simplified) processes on successful treatment
</figcaption>
</figure>
</div>
</div>
</div>
<p>where the following definitions apply:</p>
<ul>
<li><span class="math inline">\(E_R\)</span> reveal for surgical domain - 0: no, 1: yes</li>
<li><span class="math inline">\(E_D\)</span> reveal for duration domain - 0: no, 1: yes</li>
<li><span class="math inline">\(E_F\)</span> reveal for choice domain - 0: no, 1: yes</li>
<li><span class="math inline">\(R\)</span> randomised surgery - 0: DAIR, 1: revision</li>
<li><span class="math inline">\(S_R\)</span> revision type preference (pre-randomisation) - 0: DAIR, 1: one-stage, 2: two-stage</li>
<li><span class="math inline">\(R_A\)</span> allocated surgery - 0: DAIR, 1: one-stage, 2: two-stage</li>
<li><span class="math inline">\(R_P\)</span> performed surgery - 0: DAIR, 1: revision</li>
<li><span class="math inline">\(S_{R_P}\)</span> revision type performed (post-randomisation) - 0: dair, 1: one-stage, 2: two-stage</li>
<li><span class="math inline">\(D\)</span> randomised duration - 0: long, 1: short (for one-stage), 0: short, 1: long (for two-stage)</li>
<li><span class="math inline">\(D_A\)</span> allocated duration - 0: long, 1: short, 2: other</li>
<li><span class="math inline">\(S_D\)</span> selected duration - 0: long, 1: short, 2: other (sometimes duration will be selected rather than randomised)</li>
<li><span class="math inline">\(F\)</span> randomised choice - 0: norif, 1: rif</li>
<li><span class="math inline">\(F_A\)</span> allocated choice - 0: norif, 1: rif, 2: other</li>
<li><span class="math inline">\(S_F\)</span> selected choice - 0: norif, 1: rif, 2: other</li>
<li><span class="math inline">\(Y\)</span> treatment success - 0: no, 1: yes</li>
</ul>
</section>
<section id="research-questions" class="level2">
<h2 class="anchored" data-anchor-id="research-questions">Research questions</h2>
<p>The questions of interest are:</p>
<ul>
<li>Surg Domain – Early Silo – Revision is superior to DAIR (reference group)</li>
<li>AB Duration – One-stage revision – 6 weeks (short) is non-inferior to 12 weeks (long) (reference group)</li>
<li>AB Duration – Two-stage revision – 12 weeks (long) is superior to 7 days (short) (reference group)</li>
<li>AB Choice – All silos combined – Rifampicin is superior to no-rifampicin (reference group)</li>
</ul>
</section>
<section id="sec-model-spec" class="level2">
<h2 class="anchored" data-anchor-id="sec-model-spec">Model specification</h2>
<p>For each silo <span class="math inline">\(l\)</span> and site of infection <span class="math inline">\(j\)</span> we therefore simulate and model the probability of treatment success as:</p>
<p><span id="eq-mod-spec-1"><span class="math display">\[
\begin{aligned}
\mathbb{E}[Y|Q; \alpha,  \beta,\lambda] &amp;=  \text{expit}( \alpha_0 + \\
  &amp;\quad \lambda_1 \mathbb{I}(L = 1) + \lambda_2 \mathbb{I}(L = 2) + \\
  &amp;\quad (\beta_1 + \beta_2 \mathbb{I}(S_{R_P} = 1) + \beta_3 \mathbb{I}(S_{R_P} = 2) ) (1-E_R) +\\
  &amp;\quad (\beta_4 \mathbb{I}(S_{R_P} = 1) + \beta_5 \mathbb{I}(S_{R_P} = 2) )R E_R + \\
  &amp;\quad \beta_6 (1-E_D) + \\
  &amp;\quad (\beta_{7} \mathbb{I}(S_{R_P} = 1) + \beta_{8} \mathbb{I}(S_{R_P} = 2)])D E_D + \\
  &amp;\quad \beta_{9} (1-E_F) + \beta_{10} F E_F )
\end{aligned}
\tag{1}\]</span></span></p>
<p>where the <span class="math inline">\(Q\)</span>, <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\lambda\)</span> and <span class="math inline">\(\beta\)</span> denote the terms and parameters included in the model and specifically</p>
<ul>
<li><span class="math inline">\(\alpha_0\)</span> denotes the baseline log-odds of treatment success</li>
<li><span class="math inline">\(\lambda_1\)</span> change associated with membership of the late silo</li>
<li><span class="math inline">\(\lambda_2\)</span> change associated with membership of the chronic silo</li>
<li><span class="math inline">\(\beta_{1}\)</span> change under non-randomised surgical treatment relative to randomised surgical treatment</li>
<li><span class="math inline">\(\beta_{2}\)</span> relative change under non-randomised surgical treatment (receiving one-stage)</li>
<li><span class="math inline">\(\beta_{3}\)</span> relative change under non-randomised surgical treatment (receiving two-stage)</li>
<li><span class="math inline">\(\beta_{4}\)</span> change under randomised surgical treatment (revision) where one-stage procedure occurred</li>
<li><span class="math inline">\(\beta_{5}\)</span> change under randomised surgical treatment (revision) where two-stage procedure occurred</li>
<li><span class="math inline">\(\beta_{6}\)</span> change under non-randomised duration treatment</li>
<li><span class="math inline">\(\beta_{7}\)</span> change for randomised duration treatment (short duration) when one-stage surgical procedure occurred</li>
<li><span class="math inline">\(\beta_{8}\)</span> change for randomised duration treatment (long duration) when two-stage surgical procedure occurred</li>
<li><span class="math inline">\(\beta_{9}\)</span> change under non-randomised choice treatment</li>
<li><span class="math inline">\(\beta_{10}\)</span> change for randomised choice treatment (rif)</li>
</ul>
<p>In order to easily evaluate the duration effects, we to make the reference arm 12-weeks (long) in the case of one-stage revision and 7-days (short) in the case of two-stage revision.</p>
<p>In the full model, there would be additional terms to capture time trends, site variation, prognostic covariates and joint (knee/hip) effects.</p>
<p><span class="math inline">\(\beta_1\)</span>, <span class="math inline">\(\beta_2\)</span> and <span class="math inline">\(\beta_3\)</span> are required because there will be some patients who are not randomised to revision and yet will still receive either a one-stage or two-stage surgical procedure. These patients may be eligible to enter into the duration domain and therefore the duration domain effects are informed by patients receiving randomised and non-randomised surgical treatment. The <span class="math inline">\(\beta_1\)</span>, <span class="math inline">\(\beta_2\)</span> and <span class="math inline">\(\beta_3\)</span> parameters provide adjustment for non-randomised surgical treatment and <span class="math inline">\(\beta_4\)</span> and <span class="math inline">\(\beta_5\)</span> provide adjustment for the patients that did.</p>
<p>Notice that <span class="math inline">\(E_D = 0\)</span> generally implies <span class="math inline">\(S_{R_P} \notin \{1, 2\}\)</span> such that <span class="math inline">\(1-E_D\)</span> is some linear function of the other terms in the model. This can lead to estimation problems that might necessitate model re-parameterisation and it is for this reason that the simulation model drops the <span class="math inline">\((1 - E_D)\)</span> term and re-index the <span class="math inline">\(\beta\)</span> parameters:</p>
<p><span id="eq-mod-spec-2"><span class="math display">\[
\begin{aligned}
\mathbb{E}[Y|Q; \alpha,  \beta,\lambda] &amp;=  \text{expit}( \alpha_0 + \\
  &amp;\quad \lambda_1 \mathbb{I}(L = 1) + \lambda_2 \mathbb{I}(L = 2) + \\
  &amp;\quad (\beta_1 + \beta_2 \mathbb{I}(S_{R_P} = 1) + \beta_3 \mathbb{I}(S_{R_P} = 2) ) (1-E_R) +\\
  &amp;\quad (\beta_4 \mathbb{I}(S_{R_P} = 1) + \beta_5 \mathbb{I}(S_{R_P} = 2) )R E_R + \\
  &amp;\quad (\beta_{6} \mathbb{I}(S_{R_P} = 1) + \beta_{7} \mathbb{I}(S_{R_P} = 2)])D E_D + \\
  &amp;\quad \beta_{8} (1-E_F) + \beta_{9} F E_F )
\end{aligned}
\tag{2}\]</span></span></p>
</section>
<section id="examples" class="level2">
<h2 class="anchored" data-anchor-id="examples">Examples</h2>
<p>The following characterise how patients enter into the likelihood under various scenarios under <a href="#eq-mod-spec-2" class="quarto-xref">Equation&nbsp;2</a>. The main consideration is whether randomised or non-randomised surgical treatment occurs and how this impacts the other terms in the model.</p>
<section id="randomised-surgical-treatment" class="level3">
<h3 class="anchored" data-anchor-id="randomised-surgical-treatment">Randomised surgical treatment</h3>
<div class="column" style="width:100%;">
<table class="table-striped table-hover table">
<caption>Likelihood contributions under various scenarios</caption>
<colgroup>
<col style="width: 11%">
<col style="width: 44%">
<col style="width: 44%">
</colgroup>
<thead>
<tr class="header">
<th>ID</th>
<th>Covariate characteristics</th>
<th>Log-odds treatment success</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1a</td>
<td>Late silo receiving rand DAIR, non-rand AB duration and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_1 + \beta_{9}\)</span></td>
</tr>
<tr class="even">
<td>2a</td>
<td>Late silo receiving rand rev (one-stage), rand 12 weeks AB (ref) and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_1 + \beta_4 + \beta_{9}\)</span></td>
</tr>
<tr class="odd">
<td>3a</td>
<td>Late silo receiving rand rev (one-stage), rand 6 weeks AB and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_1 + \beta_4 + \beta_6 + \beta_{9}\)</span></td>
</tr>
<tr class="even">
<td>4a</td>
<td>Late silo receiving rand rev (two-stage), rand 7 days AB (ref) and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_1 + \beta_5 + \beta_{9}\)</span></td>
</tr>
<tr class="odd">
<td>5a</td>
<td>Late silo receiving rand rev (two-stage), rand 12 weeks AB and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_1 + \beta_5 + \beta_7 + \beta_{9}\)</span></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="non-randomised-surgical-treatment" class="level3">
<h3 class="anchored" data-anchor-id="non-randomised-surgical-treatment">Non-randomised surgical treatment</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>Unsure whether non-randomised surgical treatment would occur for the late-silo patients but have included anyway.</p>
<p>If the non-reveal parameters for the surgical domain were not split by surgery type, then, in the following table:</p>
<ul>
<li>ID 7b would have the same terms as ID 9b</li>
<li>ID 12b would have the same terms as ID 14b</li>
</ul>
</div>
</div>
</div>
<div class="column" style="width:100%;">
<table class="table-striped table-hover table">
<caption>Likelihood contributions under various scenarios</caption>
<colgroup>
<col style="width: 11%">
<col style="width: 44%">
<col style="width: 44%">
</colgroup>
<thead>
<tr class="header">
<th>ID</th>
<th>Covariate characteristics</th>
<th>Log-odds treatment success</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1b</td>
<td>Early silo receiving non-rand DAIR, non-rand AB duration and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \beta_1 + \beta_{9}\)</span></td>
</tr>
<tr class="even">
<td>2b</td>
<td>Early silo receiving non-rand rev (one-stage), rand 12 weeks AB (ref) and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \beta_1 + \beta_2 + \beta_{9}\)</span></td>
</tr>
<tr class="odd">
<td>3b</td>
<td>Early silo receiving non-rand rev (one-stage), rand 6 weeks AB and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \beta_1 + \beta_2 + \beta_6 + \beta_{9}\)</span></td>
</tr>
<tr class="even">
<td>4b</td>
<td>Early silo receiving non-rand rev (two-stage), rand 7 days AB (ref) and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \beta_1 + \beta_3 + \beta_{9}\)</span></td>
</tr>
<tr class="odd">
<td>5b</td>
<td>Early silo receiving non-rand rev (two-stage), rand 12 weeks AB and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \beta_1 + \beta_3 + \beta_7 + \beta_{9}\)</span></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>6b</td>
<td>Late silo receiving non-rand DAIR, non-rand AB duration and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_1 + \beta_1 + \beta_{9}\)</span></td>
</tr>
<tr class="even">
<td>7b</td>
<td>Late silo receiving non-rand rev (one-stage), rand 12 weeks AB (ref) and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_1 + \beta_1 + \beta_2 + \beta_{9}\)</span></td>
</tr>
<tr class="odd">
<td>8b</td>
<td>Late silo receiving non-rand rev (one-stage), rand 6 weeks AB and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_1 + \beta_1 + \beta_2 + \beta_6 + \beta_{9}\)</span></td>
</tr>
<tr class="even">
<td>9b</td>
<td>Late silo receiving non-rand rev (two-stage), rand 7 days AB (ref) and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_1 + \beta_1 + \beta_3 + \beta_{9}\)</span></td>
</tr>
<tr class="odd">
<td>10b</td>
<td>Late silo receiving non-rand rev (two-stage), rand 12 weeks AB and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_1 + \beta_1 + \beta_3 + \beta_7 + \beta_{9}\)</span></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>11b</td>
<td>Chronic silo receiving non-rand DAIR, non-rand AB duration and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_2 + \beta_1 + \beta_{9}\)</span></td>
</tr>
<tr class="even">
<td>12b</td>
<td>Chronic silo receiving non-rand rev (one-stage), rand 12 weeks AB (ref) and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_2 + \beta_1 + \beta_2 + \beta_{9}\)</span></td>
</tr>
<tr class="odd">
<td>13b</td>
<td>Chronic silo receiving non-rand rev (one-stage), rand 6 weeks AB and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_2 + \beta_1 + \beta_2 + \beta_6 + \beta_{9}\)</span></td>
</tr>
<tr class="even">
<td>14b</td>
<td>Chronic silo receiving non-rand rev (two-stage), rand 7 days AB (ref) and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_2 + \beta_1 + \beta_3 + \beta_{9}\)</span></td>
</tr>
<tr class="odd">
<td>15b</td>
<td>Chronic silo receiving non-rand rev (two-stage), rand 12 weeks AB and rand rif</td>
<td><span class="math inline">\(\alpha_0 + \lambda_2 + \beta_1 + \beta_3 + \beta_7 + \beta_{9}\)</span></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="treatment-effects" class="level2">
<h2 class="anchored" data-anchor-id="treatment-effects">Treatment effects</h2>
<p>For the surgical domain, the effect of interest is an average conditional log-odds ratio and is applicable to the late silo. This amounts to a weighted combination of <span class="math inline">\(\beta_2\)</span> and <span class="math inline">\(\beta_3\)</span> where the weights are the sample based expectations for the probability of receiving one-stage and two-stage surgery.</p>
<p><span class="math display">\[
\begin{aligned}
\Delta_R = \beta_4 \mathbb{E}[S_{R_P} == 1 \land R == 1] + \beta_5 \mathbb{E}[S_{R_P} == 2 \land R == 1]
\end{aligned}
\]</span></p>
<p>For the duration domain, the conditional log-odds ratios of interest are <span class="math inline">\(\beta_6\)</span> and <span class="math inline">\(\beta_7\)</span> which characterise the effect of 6 weeks (short) vs 12 weeks (long) under one-stage revision and 12 weeks (long) vs 7 days (short) in two-stage revision. For the choice domain, the conditional log-odd ratios of interest is <span class="math inline">\(\beta_{9}\)</span>, characterising the effect of rifampacin vs no-rifampacin. For the duration and choice domains, the effects are applicable to all silos.</p>
</section>
<section id="priors" class="level2">
<h2 class="anchored" data-anchor-id="priors">Priors</h2>
<p>As with the linear predictor, the priors are currently targeted towards the simulation work and may be modified in the final model.</p>
<section id="intercepts" class="level3">
<h3 class="anchored" data-anchor-id="intercepts">Intercepts</h3>
<p>The silo and infection site intercepts are given independent normal priors</p>
<span class="math display">\[\begin{aligned}
\alpha_0 \sim \mathcal{N}(0, 1.5^2)
\end{aligned}\]</span>
<p>On the probability scale, these concentrate on 0.5 with 95% of the density between 0.04 and 0.96, approximately uniform across this interval.</p>
</section>
<section id="other-covariates" class="level3">
<h3 class="anchored" data-anchor-id="other-covariates">Other covariates</h3>
<p>Independent standard normal priors are assumed for all other covariate terms effects.</p>
</section>
<section id="treatment-effects-1" class="level3">
<h3 class="anchored" data-anchor-id="treatment-effects-1">Treatment effects</h3>
<p>All covariates relating to treatment effects have standard normal priors.</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Dependent on how the randomisation process is designed and implemented, they might not even be randomised.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/github\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>