---
title: "Late silo question"
date: today
date-modified: last-modified
---



```{r, echo = F}
#| label: setup
#| code-summary: Setup

source("./R/init.R")
log_info("Called design-notes-05 notebook")
```

First consider the simplest possible setup.
Assume we have surgery ($A$) and antibiotic duration ($D_1$).
Surgery comprises dair vs revision and there are multiple versions of revision that are selected by the surgeon.
If you are assigned to dair then the backbone duration is selected.
If you are assigned to revision then the backbone duration is randomised under one-stage, and selected under two-stage.

There are two baseline characteristics that we measure that are predictive of surgical preference and duration of baseline antibiotic.

```{r, echo = F}
#| label: fig-dag1
#| fig-cap: "Simple DAG"
#| fig-cap-location: bottom
#| fig-height: 6
#| out-width: 90%

dag1 <- dagify(
  sa ~ a + ua,
  sd1 ~ d1 + sa + ud1,
  y ~ sa + ua + sd1 + ud1,
  exposure = "a",
  outcome = "y"
)

coordinates(dag1) <- list(
  x = c(
        a = 0, sa = 1,
        ua = 0,
        d1 = 0, sd1 = 2, y = 4,
        ud1 = 0 
        ),
  y = c(
        a = 8, sa = 3, 
        ua = 6,
        d1 = -1, sd1 = 1.5, y = 1, 
        ud1 = -3
        )
)

d_dag1 <- tidy_dagitty(dag1) |>
  dag_label(labels = c(
    c("a" = "expt\nsurg",
             "sa" = "surg\nchoice",
             "ua" = "surg\npref",
             "d1" = "expt\ndurn",
             "sd1" = "durn",
             "ud1" = "durn\npref",
             "y" = "trt\nsuccess"
             )
  )) 


ggplot(data = d_dag1, 
       aes(x = x, y = y, xend = xend, yend = yend)) +
  
  geom_dag_edges_diagonal(
    curvature = 1,
    edge_colour = "grey",
    edge_width = 0.2,
    start_cap = ggraph::circle(5, 'mm'),
    end_cap = ggraph::circle(7, 'mm')
  ) +
  # prevent clipping if labels fall outside frame
  coord_cartesian(clip = "off") +
  geom_dag_label_repel(aes(label = label),
                       # point.size = NA,
                       hjust = 0.5,
                       col = "black",
                       force = 0,
                       size = 2.5,
                       show.legend = FALSE
  ) +
  # geom_dag_point(size = 3) +
  # geom_dag_text(colour = 'white') +
  
  # expand scales to make room for labels
  scale_x_continuous(expand = expansion(mult = 0.15)) +
  scale_y_continuous(expand = expansion(mult = 0.15)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())


```



```{r, eval = T}
n = 1e6
get_data <- function(
    n = 1e6,
    f1 = function(a, ua, sa, d1, ud1, sd1){
      0.35 + 0.1*ua + 0.007*sd1 - 0.004*ud1
      },
    f2 = function(a, ua, sa, d1, ud1, sd1){
      0.35 + 0.1*ua + 0.0*(sa==1) + 0*(d1 == 12) - 0.004*ud1
      },
    f3 = function(a, ua, sa, d1, ud1, sd1){
      0.35 + 0.1*ua + 0.0*(sa==2) + 0*sd1 - 0.004*ud1
      }
    ){
  
  # assigned surgery
  a <- rbinom(n, 1, 0.5)
  # under receipt of rev, 70% prefer to use two-stage
  ua <- rbinom(n, 1, 0.7)
  
  # assigned duration under the setting where all units were randomised
  d1 <- sample(c(6,12), n, T)
  # but they are not so define a pref for duration of therapy after first op 
  # surgeons prefer longer duration 
  ud1 <- sample(seq(0, 12, by = 3), n, T, 1:5/sum(1:5))
  
  # surgery received
  # dair = 0, one = 1, two = 2
  sa <- rep(NA, n)
  # assume full adherence in dair group
  sa[a == 0] <- 0
  
  # assigned to rev:
  # when assigned to rev, recvd trt is per pref (70% prefer two-stage)
  idx <- which(a == 1); 
  sa[idx] <- 1 + ua[idx]
  
  # duration of antibiotic following first procedure
  sd1 <- rep(NA, n)
  # for those getting dair, duration after first opn is exactly per pref
  sd1[sa == 0] <- ud1[sa == 0]
  # assume full adherence in one-stage group
  # 6 wk vs 12 wk
  sd1[sa == 1] <- d1[sa == 1]
  # for those getting two-stage, duration after first opn is per pref
  sd1[sa == 2] <- ud1[sa == 2]
  
  d <- data.table(a, ua, sa, d1, ud1, sd1)
  
  # outcome
  
  # those receiving dair:
  d[sa == 0, p_y := f1(a, ua, sa, d1, ud1, sd1)]
  d[sa == 0, y := rbinom(.N, 1, prob = p_y)]
  
  # receiving one-stage
  d[sa == 1, p_y := f2(a, ua, sa, d1, ud1, sd1)]
  d[sa == 1, y := rbinom(.N, 1, prob = p_y)]
  
  # under two-stage
  d[sa == 2, p_y := f3(a, ua, sa, d1, ud1, sd1)]
  d[sa == 2, y := rbinom(.N, 1, prob = p_y)]
 
  d
}

# allow specification of different functions for dair, one, two
d <- get_data(n = 1e6,
              f1 = function(a, ua, sa, d1, ud1, sd1){
                0.5 - 0.1*ua + 0.007*sd1*(a==0) 
                },
              f2 = function(a, ua, sa, d1, ud1, sd1){
                0.5 - 0.1*ua + 0.007*sd1*(a==0) 
                },
              f3 = function(a, ua, sa, d1, ud1, sd1){
                0.5 - 0.1*ua + 0.007*sd1*(a==0) 
                })
```



```{r}
#| label: fig-het-prob1
#| fig-cap: "Prob trt success by duration and surgery type"
#| fig-cap-location: bottom
#| fig-height: 6
#| fig-width: 6
#| out-width: 80%

d_fig <- unique(d[, .(a, ua, sa, d1, ud1, sd1, p_y, y)])
d_fig[a == 0, trt := "DAIR"]
d_fig[a == 1, trt := "REV"]
d_fig[sa == 0, type := "DAIR"]
d_fig[sa == 1, type := "ONE"]
d_fig[sa == 2, type := "TWO"]

d_fig[ua == 0, pref_surg := "one"]
d_fig[ua == 1, pref_surg := "two"]

ggplot(d_fig, aes(x = sd1, y = p_y, group = trt, col = ud1, shape = pref_surg)) +
  geom_point() +
  scale_x_continuous("AB Duration (wks)", breaks = seq(0, 12,by = 3)) +
  scale_y_continuous("Pr(Y)") +
  scale_color_continuous("Duration pref") +
  scale_shape_discrete("Surgical pref") +
  facet_wrap(trt~type) +
  theme(legend.position="bottom", legend.box="vertical", legend.margin=margin())
```


```{r}
#| class-output: stan
#| echo: false

cat(readLines("stan/logistic-demo-03.stan"), sep = "\n")
```



```{r, eval = T, echo = T}
m1 <- cmdstanr::cmdstan_model("stan/logistic-demo-03.stan")

nsim <- 100

mu <- unlist(mclapply(1:nsim, FUN = function(i){
  
  d <- get_data(n = 200,
              f1 = function(a, ua, sa, d1, ud1, sd1){
                0.5 + 0.15*a - 0.1*ua + 0.007*sd1 - 0.007*sd1*a
                },
              f2 = function(a, ua, sa, d1, ud1, sd1){
                0.5 + 0.15*a - 0.1*ua + 0.007*sd1 - 0.007*sd1*a
                },
              f3 = function(a, ua, sa, d1, ud1, sd1){
                0.5 + 0.15*a - 0.1*ua + 0.007*sd1 - 0.007*sd1*a
                })
  
  
  X <- cbind(d$a, d$ua, d$sd1, d$ud1, d$sd1*d$a)

  ld <- list(
    N = nrow(d), 
    y = d$y,
    P = ncol(X),
    X = X,
    prior_only = 0,
    sd_a0 = 1.5,
    sd_b = 10
  )    
  f1 <- m1$sample(
      ld, iter_warmup = 1000, iter_sampling = 2000,
      parallel_chains = 2, chains = 2, refresh = 0, show_exceptions = F, 
      max_treedepth = 10)
  
  d_post_1 <- data.table(f1$draws(variables = c("rd"), format = "matrix"))
  d_post_1 <- melt(d_post_1, measure.vars = names(d_post_1))
  mean(d_post_1$value)
  
  # d_post_1 <- data.table(f1$draws(variables = c("b[1]"), format = "matrix"))
  # mean(d_post_1$`b[1]`)
  
}, mc.cores = 6))

d_smry <- data.table(mu)


```


```{r, eval = T, echo = F}
#| label: fig-hist1
#| fig-cap: "Distribution of posterior means for risk difference"
#| fig-cap-location: bottom
#| fig-height: 4
#| fig-width: 4
#| out-width: 80%


ggplot(d_smry, aes(x = mu)) +
  geom_histogram(bins = 15, fill = "grey", col = "black") +
  geom_vline(xintercept = 0.15, col = "red")

```














<!-- With regards to the surgical intervention, the assumed DAG has the following causal interpretation: -->

<!-- 1. the surgical intervention (DAIR vs revision) affects both the adopted approach for the surgery $D_1$ and also the outcome $Y$. -->
<!-- 2. the surgeons selected approach ($D_1$) further affects the outcome -->

<!-- The rationale for the direct path between $A$ and $Y$ rests on the fact that revision (conceptualised as the removal rather than retention of the joint) may differentially influence the outcome of interest. -->
<!-- This difference is independent to the surgeons' choice over the approach they take to revision. -->
<!-- Removing the $A \rightarrow Y$ path implies that the only way that $A$ can affect $Y$ is through $D_1$. -->
<!-- That is, it would imply that the type of surgery has no direct impact on the outcome other than through the type of surgery selected and performed. -->

<!-- For example, say for each pt, one of the approaches to revision was better than DAIR and one was the same.  -->
<!-- Unfortunately, the clinician always selects the wrong one.  -->
<!-- By construction, there is a direct effect of revision but we would never acknowledge the potential for this if the $A \rightarrow Y$ path were not part of the causal picture. -->

<!-- Clearly, once the various approaches to revision are collapsed and evaluated under a single category, the observed effect of **revision** is entirely dependent on the distribution of the approaches taken in the sample that is used to do the evaluation. -->












