---
title: "Population structure"

---

```{r, echo = FALSE}
source("./R/init.R")
log_info("Called population-structure notebook")
```

The following specification is for the partially factorial structure of the study.
The outcome model is specified separately.


## Silo

The total sample size is divided across the silos in proportion to the values described in the table below.
These proportions are expectations. 
Each simulated dataset will vary somewhat from these proportions due to the stochastic nature of the generation process.

::: {.column width="50%"}

| Silo |  $\pi$ |
|------|-----|
| early |  0.3 |
| late  |   0.5 |
| chronic | 0.2 |

: Silo categories ($\pi$ denotes probability of membership) {.striped .hover}
:::


## Site of infection (joint)

Each silo comprises patients assumed to have primary infection in either knee or hip (not both).
The proportion of infections associated with each joint for each silo are shown below.
As previously, these proportions are expectations and the empirical proportions observed in simulated datasets will vary from these.

::: {.column width="70%"}

Silo | Joint |  $\pi$ |
-----|-----|----|----|
early | knee |  0.4 | 
early |hip |  0.6 | 
late |knee |  0.3 | 
late |hip |  0.7 | 
chronic |knee | 0.5 | 
chronic |hip |  0.5 | 

: Site of infection ($\pi$ denotes probability of site infection conditional on silo membership) {.striped .hover}
:::

## Randomisation into surgery domain (A)

Randomisation into domain A is conditional on silo membership as detailed below.

::: {.column width="50%"}

Silo | Randomised ($e_a$) |  
-----|-----|
early |N |   
late | Y |   
chronic | Y | 

: Randomisation within domain A {.striped .hover}
:::


## Surgery domain (A)

Allocation probabilities (conditional on entry into domain A) are shown below.
Early silo does not receive randomisation and all early stage patients are assumed to receive DAIR.

::: {.column width="70%"}

Silo | Surgery type ($a$) |  $\pi$ |
-----|-----|----|----|
early | dair |     - | 
late | dair |     0.5 | 
late |revision |  0.5 | 
chronic | one-stage | 0.5 | 
chronic |two-stage |  0.5 | 

: Allocation within domain A ($\pi$ denotes probability allocation to surgery type conditional on silo membership) {.striped .hover}
:::

## Intended surgery

Late stage infections will be randomised to DAIR vs revision where revision would be planned as one or two-stage, determined by the treating clinician, i.e. not randomised.
As we do not know the assignment mechanism for one vs two-stage for the late-stage infection patients allocated to revision, we simply assume an equal chance of receiving one vs two stage.

In all other cases, the intended surgery is set to allocated surgery.

::: {.column width="70%"}

Silo | Allocation ($a$) | Intended surgery ($q$) | $\pi$ |
-----|-----|----|----|----|
early | dair | dair | - | 
late | dair |  dair |   - | 
late |revision |  one-stage | 0.5 | 
late |revision |  two-stage | 0.5 | 
chronic | one-stage | one-stage | - | 
chronic |two-stage |  two-stage | - | 

: Indended surgical approach ($\pi$ denotes probability allocation to surgery type conditional on silo membership) {.striped .hover}
:::

## Randomisation into duration domain (B)

Entry into domain B is dependent on the domain A entry and allocation and is detailed below.

::: {.column width="70%"}

Intended surgery ($q$) | Randomised ($e_b$) |  
-----|----|----|
dair |  N | 
revision |  Y | 
one-stage |  Y | 
two-stage |  Y | 

: Randomisation within domain B {.striped .hover}
:::

## Duration domain (B)

The treatment options and allocation probabilities for domain B are detailed below.
Duration of antibiotic is conditional on allocated (intended) surgery type, see above.
Patients receiving DAIR are assumed to have 12 wk duration (not randomised).

::: {.column width="70%"}

Allocation/Intended surgery ($q$) | Allocation ($b$) | $\pi$ |
-----|----|---|
dair | 12 wk |  - | 
one-stage | 6 wk |  0.5 | 
one-stage | 12 wk |  0.5 | 
two-stage | 7 day post 2  |  0.5 | 
two-stage | 12 wk post 2  |  0.5 | 

: Allocation within duration domain ($\pi$ denotes probability allocation to surgery type conditional on allocated/intended surgery)  {.striped .hover}
:::

## Randomisation into adjunctive domain (C)

60% of cohort enter into domain, the rest are flagged as ineligible as detailed below.

::: {.column width="70%"}

Silo | Randomised ($e_c$) |  $\pi$ | 
-----|-----|----|
early | Y | 0.6 |
late |   Y |  0.6 |
chronic |  Y |  0.6 |

: Randomisation within domain C ($\pi$ denotes probability patient is indicated as eligible for domain)  {.striped .hover}
:::  

## Adjunctive domain (C)

The treatment options and allocation probabilities for domain C are detailed below.

::: {.column width="70%"}

Allocation ($c$) | $\pi$ |
-----|----|
no rif | 0.5 |
rif | 0.5 |

: Allocation within adjunctive domain ($\pi$ denotes probability that an eligible patient is allocated to no rif vs rif) {.striped .hover}
:::

## Encoded specification

The above specification is bundled into an R package (`roadmap.data`) for consistent data generation for ROADMAP.

```{r}
roadmap.data::get_pop_spec()
```

The following function simulates the design matrix.

```{r}
roadmap.data::get_design
```

The data generation assumptions imply unique patients groups on which we would observe the outcome.
The outcome is known to be heterogenous across these groups and yet the stated goal is to aggregate measures of effect (odds ratios) across all these groups, e.g. no rif vs rif.
However, the effect of interest is assumed to be obtained from the model parameter that characterises the effect of antibiotic type conditional on the other covariates in the model.

```{r}
d <- roadmap.data::get_design()
unique(d[order(silo, joint, ea, a, qa, eb, b, ec, c), .SD, .SDcols = !c("id")])
```

