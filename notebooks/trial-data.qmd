---
title: "Simulated trial data"

---

```{r, echo = FALSE}
source("./R/init.R")
log_info("Called trial-data notebook")
```


Trial data is simulated under the model specification, see earlier section.
The sub-totals sum to the size of the subset (e.g. patients under late stage infection) and not the size of the total sample.
The missingness is a consequence of the partial factorial structure.

```{r}
set.seed(25)
ll <- get_trial_data(N = 2500)

d <- copy(ll$d)

```

@tbl-smry-late-Da shows the allocation to (late stage infection) dair vs rev and the balance across the remaining group levels in the data.

```{r}
#| label: tbl-smry-late-Da
#| tbl-cap: 'Simulated trial data for (late silo) surgical domain - covariate balance across other groups'
#| column: page


# domain B
d_tmp1 <- d[silo == "late", .(ea, a, eb, b)]
d_tmp2 <- d_tmp1[, .N, keyby = .(a, eb, b)]
d_B <- dcast(d_tmp2, eb + b ~ a, value.var = "N")
d_B[, domain := "B"]
colnames(d_B) <- c("rand", "group", "dair", "rev", "domain")
setcolorder(d_B, "domain")
# domain C
d_tmp1 <- d[silo == "late", .(ea, a, ec, c)]
d_tmp2 <- d_tmp1[, .N, keyby = .(a, ec, c)]
d_C <- dcast(d_tmp2, ec + c ~ a, value.var = "N")
d_C[, domain := "C"]
colnames(d_C) <- c("rand", "group", "dair", "rev", "domain")
setcolorder(d_C, "domain")

d_tbl <- rbind(d_B, d_C)
d_tbl[, group := factor(group, levels = c("w12","w06p1", "w12p1", "d07p2", "w12p2", "other", "norif", "rif"))]
d_tbl[domain == "B", domain := "AB Duration"]
d_tbl[domain == "C", domain := "AB Type"]
d_tbl <- d_tbl[order(domain, rand, group)]

cols <- c("Domain", "Randomised", "Treatment", "DAIR", "Revision")
names(cols) <- names(d_tbl)

gt_tbl <- d_tbl |> 
  gt(groupname_col = "domain"
  )  |>
  tab_spanner(
    label = html("Domain A (late silo)"),
    columns = c(dair, rev)
  ) |>
  sub_missing(
    columns = everything(),
    missing_text = "-"
  ) |>
  cols_label(.list = cols) |> 
  summary_rows(
    columns = c("dair", "rev"),
    fns = list(
      subtotal = ~ sum(., na.rm = TRUE)
    )
  ) 

gt_tbl
```

@tbl-smry-chronic-Da shows the allocation to (chronic stage infection) one vs two-stage and the balance across the remaining group levels in the data.

```{r}
#| label: tbl-smry-chronic-Da
#| tbl-cap: 'Simulated trial data for (chronic silo) surgical domain - covariate balance across other groups'
#| column: page


# domain B
d_tmp1 <- d[silo == "chronic", .(ea, a, eb, b)]
d_tmp2 <- d_tmp1[, .N, keyby = .(a, eb, b)]
d_B <- dcast(d_tmp2, eb + b ~ a, value.var = "N")
d_B[, domain := "B"]
colnames(d_B) <- c("rand", "group", "one", "two", "domain")
setcolorder(d_B, "domain")
# domain C
d_tmp1 <- d[silo == "chronic", .(ea, a, ec, c)]
d_tmp2 <- d_tmp1[, .N, keyby = .(a, ec, c)]
d_C <- dcast(d_tmp2, ec + c ~ a, value.var = "N")
d_C[, domain := "C"]
colnames(d_C) <- c("rand", "group", "one", "two", "domain")
setcolorder(d_C, "domain")

d_tbl <- rbind(d_B, d_C)
d_tbl[, group := factor(group, levels = c("w06p1", "w12p1", "d07p2", "w12p2", "other", "norif", "rif"))]
d_tbl <- d_tbl[order(domain, rand, group)]

d_tbl[domain == "B", domain := "AB Duration"]
d_tbl[domain == "C", domain := "AB Type"]

cols <- c("Domain", "Randomised", "Treatment", "One-stage", "Two-stage")
names(cols) <- names(d_tbl)

gt_tbl <- d_tbl |> 
  gt(groupname_col = "domain"
  )  |> 
  summary_rows(
    columns = c("one", "two"),
    fns = list(
      subtotal = ~ sum(., na.rm = TRUE)
    )
  )   |>
  tab_spanner(
    label = html("Domain A (chronic silo)"),
    columns = c(one, two)
  ) |>
  sub_missing(
    columns = everything(),
    missing_text = "-"
  ) |>
  cols_label(.list = cols)

gt_tbl
```

@tbl-smry-late-Db shows the allocation to (late stage infection) dair vs rev and the balance across the remaining group levels in the data.
The subsequent tables show analogous summaries.

```{r}
#| label: tbl-smry-late-Db
#| tbl-cap: 'Simulated trial data for (late silo) duration domain - covariate balance across other groups'
#| column: page

# domain B
d_tmp1 <- d[silo == "late", .(eb, b, ea, a, qa)]
d_tmp2 <- d_tmp1[, .N, keyby = .(b, ea, a, qa)]
d_tmp2[, b := factor(b, levels = c("w12", "w06p1", "w12p1", "d07p2", "w12p2"))]
d_B <- dcast(d_tmp2, ea + a + qa ~ b, value.var = "N")
d_B[, domain := "A"]
colnames(d_B) <- c("rand", "group", "plan", c("w12", "w06p1", "w12p1", "d07p2", "w12p2"), "domain")
setcolorder(d_B, "domain")
# domain C
d_tmp1 <- d[silo == "late", .(eb, b, ec, c)]
d_tmp2 <- d_tmp1[, .N, keyby = .(b, ec, c)]
d_tmp2[, b := factor(b, levels = c("w12", "w06p1", "w12p1", "d07p2", "w12p2"))]
d_C <- dcast(d_tmp2, ec + c ~ b, value.var = "N")
d_C[, domain := "C"]
colnames(d_C) <- c("rand", "group", c("w12", "w06p1", "w12p1", "d07p2", "w12p2"), "domain")
setcolorder(d_C, "domain")

d_tbl <- rbind(d_B, d_C, fill = T)
d_tbl[domain == "A", domain := "AB Duration"]
d_tbl[domain == "C", domain := "AB Type"]

cols <- c("Domain", "Randomised", "Treatment", "Plan",c("w12", "w06p1", "w12p1", "d07p2", "w12p2"))
names(cols) <- names(d_tbl)

gt_tbl <- d_tbl |> 
  gt(groupname_col = "domain"
  ) |> 
  summary_rows(
    columns = c("w12", "w06p1", "w12p1", "d07p2", "w12p2"),
    fns = list(
      subtotal = ~ sum(., na.rm = TRUE)
    )
  )   |>
  tab_spanner(
    label = html("Domain B (late silo)"),
    columns = c("w12", "w06p1", "w12p1", "d07p2", "w12p2")
  ) |>
  sub_missing(
    columns = everything(),
    missing_text = "-"
  ) |>
  cols_label(.list = cols)

gt_tbl
```




```{r}
#| label: tbl-smry-chronic-Db
#| tbl-cap: 'Simulated trial data for (chronic silo) duration domain - covariate balance across other groups'
#| column: page

# domain B
d_tmp1 <- d[silo == "chronic", .(eb, b, ea, a)]
d_tmp2 <- d_tmp1[, .N, keyby = .(b, ea, a)]
d_tmp2[, b := factor(b, levels = c("w06p1", "w12p1", "d07p2", "w12p2"))]
d_B <- dcast(d_tmp2, ea + a ~ b, value.var = "N")
d_B[, domain := "A"]
colnames(d_B) <- c("rand", "group", c("w06p1", "w12p1", "d07p2", "w12p2"), "domain")
setcolorder(d_B, "domain")
# domain C
d_tmp1 <- d[silo == "chronic", .(eb, b, ec, c)]
d_tmp2 <- d_tmp1[, .N, keyby = .(b, ec, c)]
d_tmp2[, b := factor(b, levels = c("w06p1", "w12p1", "d07p2", "w12p2"))]
d_C <- dcast(d_tmp2, ec + c ~ b, value.var = "N")
d_C[, domain := "C"]
colnames(d_C) <- c("rand", "group", c("w06p1", "w12p1", "d07p2", "w12p2"), "domain")
setcolorder(d_C, "domain")

d_tbl <- rbind(d_B, d_C, fill = T)
d_tbl[domain == "A", domain := "AB Duration"]
d_tbl[domain == "C", domain := "AB Type"]

cols <- c("Domain", "Randomised", "Treatment", c("w06p1", "w12p1", "d07p2", "w12p2"))
names(cols) <- names(d_tbl)

gt_tbl <- d_tbl |> 
  gt(groupname_col = "domain"
  ) |>
  summary_rows(
    columns = c("w06p1", "w12p1", "d07p2", "w12p2"),
    fns = list(
      subtotal = ~ sum(., na.rm = TRUE)
    )
  )   |>
  tab_spanner(
    label = html("Domain B (chronic silo)"),
    columns = c("w06p1", "w12p1", "d07p2", "w12p2")
  ) |>
  sub_missing(
    columns = everything(),
    missing_text = "-"
  ) |>
  cols_label(.list = cols)

gt_tbl
```




```{r}
#| label: tbl-smry-Dc
#| tbl-cap: 'Simulated trial data for surgical domain - covariate balance across other groups'
#| column: page

# domain B
d_tmp1 <- d[, .(c, ea, a, qa)]
d_tmp2 <- d_tmp1[, .N, keyby = .(c, ea, a, qa)]
d_tmp2[, a := factor(a, levels = c("dair", "rev", "one", "two"))]
d_tmp2[, qa := factor(qa, levels = c("dair", "one", "two"))]
d_tmp2[, c := factor(c, levels = c("other", "norif", "rif"))]
d_A <- dcast(d_tmp2, ea + a + qa ~ c, value.var = "N")
d_A[, domain := "A"]
colnames(d_A) <- c("rand", "group", "plan", c("other", "norif", "rif"), "domain")
setcolorder(d_A, "domain")
# domain B
d_tmp1 <- d[, .(c, eb, b)]
d_tmp2 <- d_tmp1[, .N, keyby = .(c, eb, b)]
d_tmp2[, b := factor(b, levels = c("w12", "w06p1", "w12p1", "d07p2", "w12p2"))]
d_tmp2[, c := factor(c, levels = c("other", "norif", "rif"))]
d_B <- dcast(d_tmp2, eb + b ~ c, value.var = "N")
d_B[, domain := "B"]
colnames(d_B) <- c("rand", "group", c("other", "norif", "rif"), "domain")
setcolorder(d_B, "domain")

d_tbl <- rbind(d_A, d_B, fill = T)
d_tbl[domain == "A", domain := "Surgical"]
d_tbl[domain == "B", domain := "AB Duration"]

cols <- c("Domain", "Randomised", "Treatment", "Plan", c("other", "norif", "rif"))
names(cols) <- names(d_tbl)

gt_tbl <- d_tbl |> 
  gt(groupname_col = "domain"
  ) |> 
  summary_rows(
    columns = c("other", "norif", "rif"),
    fns = list(
      subtotal = ~ sum(., na.rm = TRUE)
    )
  ) |>
  tab_spanner(
    label = html("Domain C"),
    columns = c("other", "norif", "rif")
  ) |>
  sub_missing(
    columns = everything(),
    missing_text = "-"
  ) |>
  cols_label(.list = cols)

gt_tbl
```



